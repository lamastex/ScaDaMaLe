<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>010_wikipediaClickStream_01ETLEDA - ScaDaMaLe/sds-3.x</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../../scroll-mdbook-outputs.css">
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/000_ScaDaMaLe.html">000_ScaDaMaLe</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/001_whySpark.html">001_whySpark</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/002_00_loginToDatabricks.html">002_00_loginToDatabricks</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/002_01_multiLingualNotebooks.html">002_01_multiLingualNotebooks</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/003_00_scalaCrashCourse.html">003_00_scalaCrashCourse</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/003_01_scalaCrashCourse.html">003_01_scalaCrashCourse</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/004_RDDsTransformationsActions.html">004_RDDsTransformationsActions</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/005_RDDsTransformationsActionsHOMEWORK.html">005_RDDsTransformationsActionsHOMEWORK</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/006a_PipedRDD.html">006a_PipedRDD</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/006_WordCount.html">006_WordCount</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007a_SparkSQLProgGuide_HW.html">007a_SparkSQLProgGuide_HW</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007b_SparkSQLProgGuide_HW.html">007b_SparkSQLProgGuide_HW</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007c_SparkSQLProgGuide_HW.html">007c_SparkSQLProgGuide_HW</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007d_SparkSQLProgGuide_HW.html">007d_SparkSQLProgGuide_HW</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007e_SparkSQLProgGuide_HW.html">007e_SparkSQLProgGuide_HW</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007f_SparkSQLProgGuide_HW.html">007f_SparkSQLProgGuide_HW</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007g_PivotInSQL.html">007g_PivotInSQL</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007_SparkSQLIntroBasics.html">007_SparkSQLIntroBasics</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/008_DiamondsPipeline_01ETLEDA.html">008_DiamondsPipeline_01ETLEDA</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/009_PowerPlantPipeline_01ETLEDA.html">009_PowerPlantPipeline_01ETLEDA</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/010_wikipediaClickStream_01ETLEDA.html" class="active">010_wikipediaClickStream_01ETLEDA</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/033_OBO_LoadExtract.html">033_OBO_LoadExtract</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html">033_OBO_PipedRDD_RigorousBayesianABTesting</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/035_LDA_CornellMovieDialogs.html">035_LDA_CornellMovieDialogs</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">ScaDaMaLe/sds-3.x</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div class="cell markdown">
<p>ScaDaMaLe Course <a href="https://lamastex.github.io/scalable-data-science/sds/3/x/">site</a> and <a href="https://lamastex.github.io/ScaDaMaLe/index.html">book</a></p>
</div>
<div class="cell markdown">
<h1 id="wiki-clickstream-analysis"><a class="header" href="#wiki-clickstream-analysis">Wiki Clickstream Analysis</a></h1>
<p>** Dataset: 3.2 billion requests collected during the month of February 2015 grouped by (src, dest) **</p>
<p>** Source: https://datahub.io/dataset/wikipedia-clickstream/ **</p>
<p><img src="https://databricks-prod-cloudfront.s3.amazonaws.com/docs/images/ny.clickstream.png" alt="NY clickstream image" title="NY clickstream image" /></p>
<p><em>This notebook requires Spark 1.6+.</em></p>
</div>
<div class="cell markdown">
<p>This notebook was originally a data analysis workflow developed with <a href="https://databricks.com/blog/2016/02/17/introducing-databricks-community-edition-apache-spark-for-all.html">Databricks Community Edition</a>, a free version of Databricks designed for learning <a href="https://spark.apache.org/">Apache Spark</a>.</p>
<p>Here we elucidate the original python notebook (<a href="/#workspace/scalable-data-science/xtraResources/sparkSummitEast2016/Wikipedia%20Clickstream%20Data">also linked here</a>) used in the talk by Michael Armbrust at Spark Summit East February 2016 shared from <a href="https://twitter.com/michaelarmbrust/status/699969850475737088">https://twitter.com/michaelarmbrust/status/699969850475737088</a> (watch later)</p>
<p><a href="https://www.youtube.com/v/35Y-rqSMCCA"><img src="http://img.youtube.com/vi/35Y-rqSMCCA/0.jpg" alt="Michael Armbrust Spark Summit East" /></a></p>
</div>
<div class="cell markdown">
<h3 id="data-set"><a class="header" href="#data-set">Data set</a></h3>
<h1 id="img-srchttpsameerf-dbc-labss3-website-us-west-2amazonawscomdatawikipediaimagesw_logo_for_labspng-altwikipedia-logo-"><a class="header" href="#img-srchttpsameerf-dbc-labss3-website-us-west-2amazonawscomdatawikipediaimagesw_logo_for_labspng-altwikipedia-logo-"><img src="http://sameerf-dbc-labs.s3-website-us-west-2.amazonaws.com/data/wikipedia/images/w_logo_for_labs.png" alt="Wikipedia Logo" /></a></h1>
<p>The data we are exploring in this lab is the February 2015 English Wikipedia Clickstream data, and it is available here: http://datahub.io/dataset/wikipedia-clickstream/resource/be85cc68-d1e6-4134-804a-fd36b94dbb82.</p>
<p>According to Wikimedia:</p>
<blockquote>
<p>&quot;The data contains counts of (referer, resource) pairs extracted from the request logs of English Wikipedia. When a client requests a resource by following a link or performing a search, the URI of the webpage that linked to the resource is included with the request in an HTTP header called the &quot;referer&quot;. This data captures 22 million (referer, resource) pairs from a total of 3.2 billion requests collected during the month of February 2015.&quot;</p>
</blockquote>
<p>The data is approximately 1.2GB and it is hosted in the following Databricks file: <code>/databricks-datasets/wikipedia-datasets/data-001/clickstream/raw-uncompressed</code></p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(dbutils.fs.ls(&quot;/databricks-datasets/wikipedia-datasets/&quot;))
</code></pre>
</div>
<div class="cell markdown">
<h3 id="let-us-first-understand-this-wikimedia-data-set-a-bit-more"><a class="header" href="#let-us-first-understand-this-wikimedia-data-set-a-bit-more">Let us first understand this Wikimedia data set a bit more</a></h3>
<p>Let's read the datahub-hosted link <a href="https://datahub.io/dataset/wikipedia-clickstream">https://datahub.io/dataset/wikipedia-clickstream</a> in the embedding below. Also click the <a href="http://ewulczyn.github.io/Wikipedia_Clickstream_Getting_Started/">blog</a> by Ellery Wulczyn, Data Scientist at The Wikimedia Foundation, to better understand how the data was generated (remember to Right-Click and use -&gt; and &lt;- if navigating within the embedded html frame below).</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//This allows easy embedding of publicly available information into any other notebook
//when viewing in git-book just ignore this block - you may have to manually chase the URL in frameIt(&quot;URL&quot;).
//Example usage:
// displayHTML(frameIt(&quot;https://en.wikipedia.org/wiki/Latent_Dirichlet_allocation#Topics_in_LDA&quot;,250))
def frameIt( u:String, h:Int ) : String = {
      &quot;&quot;&quot;&lt;iframe 
 src=&quot;&quot;&quot;&quot;+ u+&quot;&quot;&quot;&quot;
 width=&quot;95%&quot; height=&quot;&quot;&quot;&quot; + h + &quot;&quot;&quot;&quot;
 sandbox&gt;
  &lt;p&gt;
    &lt;a href=&quot;http://spark.apache.org/docs/latest/index.html&quot;&gt;
      Fallback link for browsers that, unlikely, don't support frames
    &lt;/a&gt;
  &lt;/p&gt;
&lt;/iframe&gt;&quot;&quot;&quot;
   }
displayHTML(frameIt(&quot;https://datahub.io/dataset/wikipedia-clickstream&quot;,500))
</code></pre>
</div>
<div class="cell markdown">
<p>Run the next two cells for some housekeeping.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">if (org.apache.spark.BuildInfo.sparkBranch &lt; &quot;1.6&quot;) sys.error(&quot;Attach this notebook to a cluster running Spark 1.6+&quot;)
</code></pre>
</div>
<div class="cell markdown">
<h3 id="loading-and-exploring-the-data"><a class="header" href="#loading-and-exploring-the-data">Loading and Exploring the data</a></h3>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val data = sc.textFile(&quot;dbfs:///databricks-datasets/wikipedia-datasets/data-001/clickstream/raw-uncompressed&quot;)
</code></pre>
</div>
<div class="cell markdown">
<h5 id="looking-at-the-first-few-lines-of-the-data"><a class="header" href="#looking-at-the-first-few-lines-of-the-data">Looking at the first few lines of the data</a></h5>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">data.take(5).foreach(println) 
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">data.take(2)
</code></pre>
</div>
<div class="cell markdown">
<ul>
<li>The first line looks like a header</li>
<li>The second line (separated from the first by &quot;,&quot;) contains data organized according to the header, i.e., <code>prev_id</code> = 3632887, <code>curr_id</code> = 121&quot;, and so on.</li>
</ul>
<p>Actually, here is the meaning of each column:</p>
<ul>
<li>
<p><code>prev_id</code>: if the referer does not correspond to an article in the main namespace of English Wikipedia, this value will be empty. Otherwise, it contains the unique MediaWiki page ID of the article corresponding to the referer i.e. the previous article the client was on</p>
</li>
<li>
<p><code>curr_id</code>: the MediaWiki unique page ID of the article the client requested</p>
</li>
<li>
<p><code>prev_title</code>: the result of mapping the referer URL to the fixed set of values described below</p>
</li>
<li>
<p><code>curr_title</code>: the title of the article the client requested</p>
</li>
<li>
<p><code>n</code>: the number of occurrences of the (referer, resource) pair</p>
</li>
<li>
<p><code>type</code></p>
<ul>
<li>&quot;link&quot; if the referer and request are both articles and the referer links to the request</li>
<li>&quot;redlink&quot; if the referer is an article and links to the request, but the request is not in the production enwiki.page table</li>
<li>&quot;other&quot; if the <em>referer</em> and request are both articles but the referer does not link to the request. This can happen when clients search or spoof their refer</li>
</ul>
</li>
</ul>
</div>
<div class="cell markdown">
<p>Referers were mapped to a fixed set of values corresponding to internal traffic or external traffic from one of the top 5 global traffic sources to English Wikipedia, based on this scheme:</p>
<blockquote>
<ul>
<li>an article in the main namespace of English Wikipedia -&gt; the article title</li>
<li>any Wikipedia page that is not in the main namespace of English Wikipedia -&gt; <code>other-wikipedia</code></li>
<li>an empty referer -&gt; <code>other-empty</code></li>
<li>a page from any other Wikimedia project -&gt; <code>other-internal</code></li>
<li>Google -&gt; <code>other-google</code></li>
<li>Yahoo -&gt; <code>other-yahoo</code></li>
<li>Bing -&gt; <code>other-bing</code></li>
<li>Facebook -&gt; <code>other-facebook</code></li>
<li>Twitter -&gt; <code>other-twitter</code></li>
<li>anything else -&gt; <code>other-other</code></li>
</ul>
</blockquote>
</div>
<div class="cell markdown">
<p>In the second line of the file above, we can see there were 121 clicks from Google to the Wikipedia page on &quot;!!&quot; (double exclamation marks). People search for everything!</p>
<ul>
<li>prev_id = <em>(nothing)</em></li>
<li>curr_id = 3632887 <em>--&gt; (Wikipedia page ID)</em></li>
<li>n = 121 <em>(People clicked from Google to this page 121 times in this month.)</em></li>
<li>prev_title = other-google <em>(This data record is for referals from Google.)</em></li>
<li>curr_title = !! <em>(This Wikipedia page is about a double exclamation mark.)</em></li>
<li>type = other</li>
</ul>
</div>
<div class="cell markdown">
<h3 id="create-a-dataframe-from-this-csv"><a class="header" href="#create-a-dataframe-from-this-csv">Create a DataFrame from this CSV</a></h3>
<ul>
<li>From the next Spark release - 2.0, CSV as a datasource will be part of Spark's standard release. But, we are using Spark 1.6</li>
</ul>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// Load the raw dataset stored as a CSV file
val clickstream = sqlContext
    .read
    .format(&quot;com.databricks.spark.csv&quot;)
    .options(Map(&quot;header&quot; -&gt; &quot;true&quot;, &quot;delimiter&quot; -&gt; &quot;\t&quot;, &quot;mode&quot; -&gt; &quot;PERMISSIVE&quot;, &quot;inferSchema&quot; -&gt; &quot;true&quot;))
    .load(&quot;dbfs:///databricks-datasets/wikipedia-datasets/data-001/clickstream/raw-uncompressed&quot;)
  
</code></pre>
</div>
<div class="cell markdown">
<h5 id="print-the-schema"><a class="header" href="#print-the-schema">Print the schema</a></h5>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">clickstream.printSchema
</code></pre>
</div>
<div class="cell markdown">
<h4 id="display-some-sample-data"><a class="header" href="#display-some-sample-data">Display some sample data</a></h4>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(clickstream)
</code></pre>
</div>
<div class="cell markdown">
<p>Display is a utility provided by Databricks. If you are programming directly in Spark, use the show(numRows: Int) function of DataFrame</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">clickstream.show(5)
</code></pre>
</div>
<div class="cell markdown">
<h3 id="reading-from-disk-vs-memory"><a class="header" href="#reading-from-disk-vs-memory">Reading from disk vs memory</a></h3>
<p>The 1.2 GB Clickstream file is currently on S3, which means each time you scan through it, your Spark cluster has to read the 1.2 GB of data remotely over the network.</p>
</div>
<div class="cell markdown">
<p>Call the <code>count()</code> action to check how many rows are in the DataFrame and to see how long it takes to read the DataFrame from S3.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">clickstream.cache().count()
</code></pre>
</div>
<div class="cell markdown">
<ul>
<li>It took about several minutes to read the 1.2 GB file into your Spark cluster. The file has 22.5 million rows/lines.</li>
<li>Although we have called cache, remember that it is evaluated (cached) only when an action(count) is called</li>
</ul>
</div>
<div class="cell markdown">
<p>Now call count again to see how much faster it is to read from memory</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">clickstream.count()
</code></pre>
</div>
<div class="cell markdown">
<ul>
<li>Orders of magnitude faster!</li>
<li>If you are going to be using the same data source multiple times, it is better to cache it in memory</li>
</ul>
</div>
<div class="cell markdown">
<h3 id="what-are-the-top-10-articles-requested"><a class="header" href="#what-are-the-top-10-articles-requested">What are the top 10 articles requested?</a></h3>
<p>To do this we also need to order by the sum of column <code>n</code>, in descending order.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//Type in your answer here...
display(clickstream
  .select(clickstream(&quot;curr_title&quot;), clickstream(&quot;n&quot;))
  .groupBy(&quot;curr_title&quot;)
  .sum()
  .orderBy($&quot;sum(n)&quot;.desc)
  .limit(10))
</code></pre>
</div>
<div class="cell markdown">
<h3 id="who-sent-the-most-traffic-to-wikipedia-in-feb-2015"><a class="header" href="#who-sent-the-most-traffic-to-wikipedia-in-feb-2015">Who sent the most traffic to Wikipedia in Feb 2015?</a></h3>
<p>In other words, who were the top referers to Wikipedia?</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(clickstream
  .select(clickstream(&quot;prev_title&quot;), clickstream(&quot;n&quot;))
  .groupBy(&quot;prev_title&quot;)
  .sum()
  .orderBy($&quot;sum(n)&quot;.desc)
  .limit(10))
</code></pre>
</div>
<div class="cell markdown">
<p>As expected, the top referer by a large margin is Google. Next comes refererless traffic (usually clients using HTTPS). The third largest sender of traffic to English Wikipedia are Wikipedia pages that are not in the main namespace (ns = 0) of English Wikipedia. Learn about the Wikipedia namespaces here: https://en.wikipedia.org/wiki/Wikipedia:Project_namespace</p>
<p>Also, note that Twitter sends 10x more requests to Wikipedia than Facebook.</p>
</div>
<div class="cell markdown">
<h3 id="what-were-the-top-5-trending-articles-people-from-twitter-were-looking-up-in-wikipedia"><a class="header" href="#what-were-the-top-5-trending-articles-people-from-twitter-were-looking-up-in-wikipedia">What were the top 5 trending articles people from Twitter were looking up in Wikipedia?</a></h3>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//Type in your answer here...
display(clickstream
  .select(clickstream(&quot;curr_title&quot;), clickstream(&quot;prev_title&quot;), clickstream(&quot;n&quot;))
  .filter(&quot;prev_title = 'other-twitter'&quot;)
  .groupBy(&quot;curr_title&quot;)
  .sum()
  .orderBy($&quot;sum(n)&quot;.desc)
  .limit(5))
</code></pre>
</div>
<div class="cell markdown">
<h4 id="what-percentage-of-page-visits-in-wikipedia-are-from-other-pages-in-wikipedia-itself"><a class="header" href="#what-percentage-of-page-visits-in-wikipedia-are-from-other-pages-in-wikipedia-itself">What percentage of page visits in Wikipedia are from other pages in Wikipedia itself?</a></h4>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val allClicks = clickstream.selectExpr(&quot;sum(n)&quot;).first.getLong(0)
val referals = clickstream.
                filter(clickstream(&quot;prev_id&quot;).isNotNull).
                selectExpr(&quot;sum(n)&quot;).first.getLong(0)
(referals * 100.0) / allClicks
</code></pre>
</div>
<div class="cell markdown">
<h4 id="register-the-dataframe-to-perform-more-complex-queries"><a class="header" href="#register-the-dataframe-to-perform-more-complex-queries">Register the DataFrame to perform more complex queries</a></h4>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">clickstream.createOrReplaceTempView(&quot;clicks&quot;)
</code></pre>
</div>
<div class="cell markdown">
<h4 id="which-wikipedia-pages-have-the-most-referrals-to-the-donald-trump-page"><a class="header" href="#which-wikipedia-pages-have-the-most-referrals-to-the-donald-trump-page">Which Wikipedia pages have the most referrals to the Donald Trump page?</a></h4>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-sql">SELECT *
FROM clicks
WHERE 
  curr_title = 'Donald_Trump' AND
  prev_id IS NOT NULL AND prev_title != 'Main_Page'
ORDER BY n DESC
LIMIT 20
</code></pre>
</div>
<div class="cell markdown">
<h4 id="youtry-top-referrers-to-other-2016-us-presidential-candidate-pages"><a class="header" href="#youtry-top-referrers-to-other-2016-us-presidential-candidate-pages">YouTry: Top referrers to other 2016 US presidential candidate pages</a></h4>
<p><code>'Donald_Trump', 'Bernie_Sanders', 'Hillary_Rodham_Clinton', 'Ted_Cruz'</code></p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-sql">-- YouTry 
---
-- fill in the right sql query here
</code></pre>
</div>
<div class="cell markdown">
<h4 id="load-a-visualization-library"><a class="header" href="#load-a-visualization-library">Load a visualization library</a></h4>
<p>This code is copied after doing a live google search (by Michael Armbrust at Spark Summit East February 2016 shared from <a href="https://twitter.com/michaelarmbrust/status/699969850475737088">https://twitter.com/michaelarmbrust/status/699969850475737088</a>). The <code>d3ivan</code> package is an updated version of the original package used by Michael Armbrust as it needed some TLC for Spark 2.2 on newer databricks notebook. These changes were kindly made by Ivan Sadikov from Middle Earth.</p>
<p>You need to hit the Play Button in next cell and 'Run Cell' exactly once.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">package d3ivan
// We use a package object so that we can define top level classes like Edge that need to be used in other cells

import org.apache.spark.sql._
import com.databricks.backend.daemon.driver.EnhancedRDDFunctions.displayHTML

case class Edge(src: String, dest: String, count: Long)

case class Node(name: String)
case class Link(source: Int, target: Int, value: Long)
case class Graph(nodes: Seq[Node], links: Seq[Link])

object graphs {
// val sqlContext = SQLContext.getOrCreate(org.apache.spark.SparkContext.getOrCreate())  /// fix
val sqlContext = SparkSession.builder().getOrCreate().sqlContext
import sqlContext.implicits._
  
def force(clicks: Dataset[Edge], height: Int = 100, width: Int = 960): Unit = {
  val data = clicks.collect()
  val nodes = (data.map(_.src) ++ data.map(_.dest)).map(_.replaceAll(&quot;_&quot;, &quot; &quot;)).toSet.toSeq.map(Node)
  val links = data.map { t =&gt;
    Link(nodes.indexWhere(_.name == t.src.replaceAll(&quot;_&quot;, &quot; &quot;)), nodes.indexWhere(_.name == t.dest.replaceAll(&quot;_&quot;, &quot; &quot;)), t.count / 20 + 1)
  }
  showGraph(height, width, Seq(Graph(nodes, links)).toDF().toJSON.first())
}

/**
 * Displays a force directed graph using d3
 * input: {&quot;nodes&quot;: [{&quot;name&quot;: &quot;...&quot;}], &quot;links&quot;: [{&quot;source&quot;: 1, &quot;target&quot;: 2, &quot;value&quot;: 0}]}
 */
def showGraph(height: Int, width: Int, graph: String): Unit = {

displayHTML(s&quot;&quot;&quot;
&lt;style&gt;

.node_circle {
  stroke: #777;
  stroke-width: 1.3px;
}

.node_label {
  pointer-events: none;
}

.link {
  stroke: #777;
  stroke-opacity: .2;
}

.node_count {
  stroke: #777;
  stroke-width: 1.0px;
  fill: #999;
}

text.legend {
  font-family: Verdana;
  font-size: 13px;
  fill: #000;
}

.node text {
  font-family: &quot;Helvetica Neue&quot;,&quot;Helvetica&quot;,&quot;Arial&quot;,sans-serif;
  font-size: 17px;
  font-weight: 200;
}

&lt;/style&gt;

&lt;div id=&quot;clicks-graph&quot;&gt;
&lt;script src=&quot;//d3js.org/d3.v3.min.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;

var graph = $graph;

var width = $width,
    height = $height;

var color = d3.scale.category20();

var force = d3.layout.force()
    .charge(-700)
    .linkDistance(180)
    .size([width, height]);

var svg = d3.select(&quot;#clicks-graph&quot;).append(&quot;svg&quot;)
    .attr(&quot;width&quot;, width)
    .attr(&quot;height&quot;, height);
    
force
    .nodes(graph.nodes)
    .links(graph.links)
    .start();

var link = svg.selectAll(&quot;.link&quot;)
    .data(graph.links)
    .enter().append(&quot;line&quot;)
    .attr(&quot;class&quot;, &quot;link&quot;)
    .style(&quot;stroke-width&quot;, function(d) { return Math.sqrt(d.value); });

var node = svg.selectAll(&quot;.node&quot;)
    .data(graph.nodes)
    .enter().append(&quot;g&quot;)
    .attr(&quot;class&quot;, &quot;node&quot;)
    .call(force.drag);

node.append(&quot;circle&quot;)
    .attr(&quot;r&quot;, 10)
    .style(&quot;fill&quot;, function (d) {
    if (d.name.startsWith(&quot;other&quot;)) { return color(1); } else { return color(2); };
})

node.append(&quot;text&quot;)
      .attr(&quot;dx&quot;, 10)
      .attr(&quot;dy&quot;, &quot;.35em&quot;)
      .text(function(d) { return d.name });
      
//Now we are giving the SVGs co-ordinates - the force layout is generating the co-ordinates which this code is using to update the attributes of the SVG elements
force.on(&quot;tick&quot;, function () {
    link.attr(&quot;x1&quot;, function (d) {
        return d.source.x;
    })
        .attr(&quot;y1&quot;, function (d) {
        return d.source.y;
    })
        .attr(&quot;x2&quot;, function (d) {
        return d.target.x;
    })
        .attr(&quot;y2&quot;, function (d) {
        return d.target.y;
    });
    d3.selectAll(&quot;circle&quot;).attr(&quot;cx&quot;, function (d) {
        return d.x;
    })
        .attr(&quot;cy&quot;, function (d) {
        return d.y;
    });
    d3.selectAll(&quot;text&quot;).attr(&quot;x&quot;, function (d) {
        return d.x;
    })
        .attr(&quot;y&quot;, function (d) {
        return d.y;
    });
});
&lt;/script&gt;
&lt;/div&gt;
&quot;&quot;&quot;)
}
  
  def help() = {
displayHTML(&quot;&quot;&quot;
&lt;p&gt;
Produces a force-directed graph given a collection of edges of the following form:&lt;/br&gt;
&lt;tt&gt;&lt;font color=&quot;#a71d5d&quot;&gt;case class&lt;/font&gt; &lt;font color=&quot;#795da3&quot;&gt;Edge&lt;/font&gt;(&lt;font color=&quot;#ed6a43&quot;&gt;src&lt;/font&gt;: &lt;font color=&quot;#a71d5d&quot;&gt;String&lt;/font&gt;, &lt;font color=&quot;#ed6a43&quot;&gt;dest&lt;/font&gt;: &lt;font color=&quot;#a71d5d&quot;&gt;String&lt;/font&gt;, &lt;font color=&quot;#ed6a43&quot;&gt;count&lt;/font&gt;: &lt;font color=&quot;#a71d5d&quot;&gt;Long&lt;/font&gt;)&lt;/tt&gt;
&lt;/p&gt;
&lt;p&gt;Usage:&lt;br/&gt;
&lt;tt&gt;&lt;font color=&quot;#a71d5d&quot;&gt;import&lt;/font&gt; &lt;font color=&quot;#ed6a43&quot;&gt;d3._&lt;/font&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&lt;font color=&quot;#795da3&quot;&gt;graphs.force&lt;/font&gt;(&lt;/br&gt;
&amp;nbsp;&amp;nbsp;&lt;font color=&quot;#ed6a43&quot;&gt;height&lt;/font&gt; = &lt;font color=&quot;#795da3&quot;&gt;500&lt;/font&gt;,&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&lt;font color=&quot;#ed6a43&quot;&gt;width&lt;/font&gt; = &lt;font color=&quot;#795da3&quot;&gt;500&lt;/font&gt;,&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&lt;font color=&quot;#ed6a43&quot;&gt;clicks&lt;/font&gt;: &lt;font color=&quot;#795da3&quot;&gt;Dataset&lt;/font&gt;[&lt;font color=&quot;#795da3&quot;&gt;Edge&lt;/font&gt;])&lt;/tt&gt;
&lt;/p&gt;&quot;&quot;&quot;)
  }
}
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">d3ivan.graphs.help()
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">d3ivan.graphs.force(
  height = 800,
  width = 800,
  clicks = sql(&quot;&quot;&quot;
    SELECT 
      prev_title AS src,
      curr_title AS dest,
      n AS count FROM clicks
    WHERE 
      curr_title IN ('Donald_Trump', 'Bernie_Sanders', 'Hillary_Rodham_Clinton', 'Ted_Cruz') AND
      prev_id IS NOT NULL AND prev_title != 'Main_Page'
    ORDER BY n DESC
    LIMIT 20&quot;&quot;&quot;).as[d3ivan.Edge])
</code></pre>
</div>
<div class="cell markdown">
<p>What we have done above is essentially pass the output of an SQL query into a D3 visualizer via javascript. Don't worry about all the details. The main idea here is that SQL and interactive visualizations usually come together in a proper data exploratory tool and the above steps are minimal excursions into how to do it in a simple way from within a notebook environment like databricks. Python and R have many plotting libraries and we can always write the dataframe to parquet and load it into pySpark or SparkR to leverage those languages. But D3 is a nice solutions also especially if you want somethinf customized for your queries.</p>
</div>
<div class="cell markdown">
<h3 id="convert-raw-data-to-parquet"><a class="header" href="#convert-raw-data-to-parquet">Convert raw data to parquet</a></h3>
<p><strong>Recall:</strong></p>
<p><a href="https://parquet.apache.org/">Apache Parquet</a> is a <a href="http://en.wikipedia.org/wiki/Column-oriented_DBMS">columnar storage</a> format available to any project in the Hadoop ecosystem, regardless of the choice of data processing framework, data model or programming language. It is a more efficient way to store data frames.</p>
<ul>
<li>To understand the ideas read <a href="http://research.google.com/pubs/pub36632.html">Dremel: Interactive Analysis of Web-Scale Datasets, Sergey Melnik, Andrey Gubarev, Jing Jing Long, Geoffrey Romer, Shiva Shivakumar, Matt Tolton and Theo Vassilakis,Proc. of the 36th Int'l Conf on Very Large Data Bases (2010), pp. 330-339</a>, whose Abstract is as follows:
<ul>
<li>Dremel is a scalable, interactive ad-hoc query system for analysis of read-only nested data. By combining multi-level execution trees and columnar data layouts it is <strong>capable of running aggregation queries over trillion-row tables in seconds</strong>. The system <strong>scales to thousands of CPUs and petabytes of data, and has thousands of users at Google</strong>. In this paper, we describe the architecture and implementation of Dremel, and explain how it complements MapReduce-based computing. We present a novel columnar storage representation for nested records and discuss experiments on few-thousand node instances of the system.</li>
</ul>
</li>
</ul>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">displayHTML(frameIt(&quot;https://parquet.apache.org/documentation/latest/&quot;,350))
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// Convert the DatFrame to a more efficent format to speed up our analysis
clickstream.
  write.
  mode(SaveMode.Overwrite).
  parquet(&quot;/datasets/wiki-clickstream&quot;) 
</code></pre>
</div>
<div class="cell markdown">
<h4 id="load-parquet-file-efficiently-and-quickly-into-a-dataframe"><a class="header" href="#load-parquet-file-efficiently-and-quickly-into-a-dataframe">Load parquet file efficiently and quickly into a DataFrame</a></h4>
<p>Now we can simply load from this parquet file next time instead of creating the RDD from the text file (much slower).</p>
<p>Also using parquet files to store DataFrames allows us to go between languages quickly in a a scalable manner.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val clicks = sqlContext.read.parquet(&quot;/datasets/wiki-clickstream&quot;)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">clicks.printSchema
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(clicks)  // let's display this DataFrame
</code></pre>
</div>
<div class="cell markdown">
<h5 id="dataframe-in-python"><a class="header" href="#dataframe-in-python">DataFrame in python</a></h5>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python">clicksPy = sqlContext.read.parquet(&quot;/datasets/wiki-clickstream&quot;)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python"># in Python you need to put the object int its own line like this to get the type information
clicksPy 
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python">clicksPy.show()
</code></pre>
</div>
<div class="cell markdown">
<p>Now you can continue from the original python notebook tweeted by Michael.</p>
<p>Recall from the beginning of this notebook that this python databricks notebook was used in the talk by Michael Armbrust at Spark Summit East February 2016 shared from <a href="https://twitter.com/michaelarmbrust/status/699969850475737088">https://twitter.com/michaelarmbrust/status/699969850475737088</a></p>
<p>(watch now, if you haven't already!)</p>
<p><a href="https://www.youtube.com/watch?v=35Y-rqSMCCA"><img src="http://img.youtube.com/vi/35Y-rqSMCCA/0.jpg" alt="Michael Armbrust Spark Summit East" /></a></p>
</div>
<div class="cell markdown">
<p><strong>You Try!</strong></p>
<p>Try to laoad a DataFrame in R from the parquet file just as we did for python. Read the docs in databricks guide first:</p>
<ul>
<li><a href="https://docs.databricks.com/spark/latest/sparkr/overview.html">https://docs.databricks.com/spark/latest/sparkr/overview.html</a></li>
</ul>
<p>And see the <code>R</code> example in the Programming Guide:</p>
<ul>
<li><a href="https://spark.apache.org/docs/latest/sql-programming-guide.html#parquet-files">https://spark.apache.org/docs/latest/sql-programming-guide.html#parquet-files</a>.</li>
</ul>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-r">library(SparkR)

# just a quick test
df &lt;- createDataFrame(faithful)
head(df)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-r"># Read in the Parquet file created above. Parquet files are self-describing so the schema is preserved.
# The result of loading a parquet file is also a DataFrame.
clicksR &lt;- read.df(&quot;/datasets/wiki-clickstream&quot;, source = &quot;parquet&quot;)
clicksR # in R you need to put the object int its own line like this to get the type information
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-r">head(clicksR)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-r">display(clicksR)
</code></pre>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../contents/000_1-sds-3-x/009_PowerPlantPipeline_01ETLEDA.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../contents/000_1-sds-3-x/033_OBO_LoadExtract.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../contents/000_1-sds-3-x/009_PowerPlantPipeline_01ETLEDA.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../contents/000_1-sds-3-x/033_OBO_LoadExtract.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
