<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>033_OBO_LoadExtract - ScaDaMaLe/sds-3.x</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../../scroll-mdbook-outputs.css">
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/000_ScaDaMaLe.html">000_ScaDaMaLe</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/001_whySpark.html">001_whySpark</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/002_00_loginToDatabricks.html">002_00_loginToDatabricks</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/002_01_multiLingualNotebooks.html">002_01_multiLingualNotebooks</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/003_00_scalaCrashCourse.html">003_00_scalaCrashCourse</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/003_01_scalaCrashCourse.html">003_01_scalaCrashCourse</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/004_RDDsTransformationsActions.html">004_RDDsTransformationsActions</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/005_RDDsTransformationsActionsHOMEWORK.html">005_RDDsTransformationsActionsHOMEWORK</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/006a_PipedRDD.html">006a_PipedRDD</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/006_WordCount.html">006_WordCount</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007a_SparkSQLProgGuide_HW.html">007a_SparkSQLProgGuide_HW</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007b_SparkSQLProgGuide_HW.html">007b_SparkSQLProgGuide_HW</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007c_SparkSQLProgGuide_HW.html">007c_SparkSQLProgGuide_HW</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007d_SparkSQLProgGuide_HW.html">007d_SparkSQLProgGuide_HW</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007e_SparkSQLProgGuide_HW.html">007e_SparkSQLProgGuide_HW</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007f_SparkSQLProgGuide_HW.html">007f_SparkSQLProgGuide_HW</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007g_PivotInSQL.html">007g_PivotInSQL</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/007_SparkSQLIntroBasics.html">007_SparkSQLIntroBasics</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/008_DiamondsPipeline_01ETLEDA.html">008_DiamondsPipeline_01ETLEDA</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/009_PowerPlantPipeline_01ETLEDA.html">009_PowerPlantPipeline_01ETLEDA</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/010_wikipediaClickStream_01ETLEDA.html">010_wikipediaClickStream_01ETLEDA</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/033_OBO_LoadExtract.html" class="active">033_OBO_LoadExtract</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html">033_OBO_PipedRDD_RigorousBayesianABTesting</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_1-sds-3-x/035_LDA_CornellMovieDialogs.html">035_LDA_CornellMovieDialogs</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">ScaDaMaLe/sds-3.x</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div class="cell markdown">
<p>ScaDaMaLe Course <a href="https://lamastex.github.io/scalable-data-science/sds/3/x/">site</a> and <a href="https://lamastex.github.io/ScaDaMaLe/index.html">book</a></p>
</div>
<div class="cell markdown">
<h1 id="old-bailey-online-data-analysis-in-apache-spark"><a class="header" href="#old-bailey-online-data-analysis-in-apache-spark">Old Bailey Online Data Analysis in Apache Spark</a></h1>
<p>2016, by Raaz Sainudiin and James Smithies is licensed under <a href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
<p><strong>Old Bailey, London's Central Criminal Court, 1674 to 1913</strong></p>
<ul>
<li>with Full XML Data for another great project. This is a starting point for ETL of Old Bailey Online Data from <a href="http://lamastex.org/datasets/public/OldBailey/index.html">http://lamastex.org/datasets/public/OldBailey/index.html</a>.</li>
</ul>
<p>This work merely builds on <a href="https://www.oldbaileyonline.org/">Old Bailey Online by Clive Emsley, Tim Hitchcock and Robert Shoemaker</a> that is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License. Permissions beyond the scope of this license may be available at https://www.oldbaileyonline.org/static/Legal-info.jsp.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//This allows easy embedding of publicly available information into any other notebook
//when viewing in git-book just ignore this block - you may have to manually chase the URL in frameIt(&quot;URL&quot;).
//Example usage:
// displayHTML(frameIt(&quot;https://en.wikipedia.org/wiki/Latent_Dirichlet_allocation#Topics_in_LDA&quot;,250))
def frameIt( u:String, h:Int ) : String = {
      &quot;&quot;&quot;&lt;iframe 
 src=&quot;&quot;&quot;&quot;+ u+&quot;&quot;&quot;&quot;
 width=&quot;95%&quot; height=&quot;&quot;&quot;&quot; + h + &quot;&quot;&quot;&quot;
 sandbox&gt;
  &lt;p&gt;
    &lt;a href=&quot;http://spark.apache.org/docs/latest/index.html&quot;&gt;
      Fallback link for browsers that, unlikely, don't support frames
    &lt;/a&gt;
  &lt;/p&gt;
&lt;/iframe&gt;&quot;&quot;&quot;
   }
displayHTML(frameIt(&quot;https://www.oldbaileyonline.org/&quot;, 450))
</code></pre>
</div>
<div class="cell markdown">
<h3 id="this-exciting-dataset-is-here-for-a-course-project-in-digital-humanities"><a class="header" href="#this-exciting-dataset-is-here-for-a-course-project-in-digital-humanities">This exciting dataset is here for a course project in digital humanities</a></h3>
<h4 id="to-understand-the-extraction-job-we-are-about-to-do-here"><a class="header" href="#to-understand-the-extraction-job-we-are-about-to-do-here">To understand the extraction job we are about to do here:</a></h4>
<ul>
<li>see <a href="http://lamastex.org/preprints/20150828_civilizingProcOBO.pdf">Jasper Mackenzie, Raazesh Sainudiin, James Smithies and Heather Wolffram, A nonparametric view of the civilizing process in London's Old Bailey, Research Report UCDMS2015/1, 32 pages, 2015</a>.</li>
</ul>
</div>
<div class="cell markdown">
<p>The data is already loaded in dbfs (see dowloading and loading section below for these details).</p>
</div>
<div class="cell markdown">
<h1 id="analysing-the-full-old-bailey-online-sessions-papers-dataset"><a class="header" href="#analysing-the-full-old-bailey-online-sessions-papers-dataset">Analysing the Full Old Bailey Online Sessions Papers Dataset</a></h1>
<p>First <strong>Step 0: Dowloading and Loading Data (The Full Dataset)</strong> below should have been done on the shard.
This currently cannot be done in Community Edition as the dataset is not loaded into the dbfs available in CE yet. But the datset is in the academic shard and this is a walkthorugh of the Old Bailey Online data in the academic shard.</p>
<p>Let's first check that the datasets are there in the distributed file system.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(dbutils.fs.ls(&quot;dbfs:/datasets/obo/tei/&quot;)) // full data if you have it - not in CE!!
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(dbutils.fs.ls(&quot;dbfs:/datasets/obo/tei/ordinarysAccounts&quot;))
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(dbutils.fs.ls(&quot;dbfs:/datasets/obo/tei/sessionsPapers&quot;))
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">displayHTML(frameIt(&quot;https://en.wikipedia.org/wiki/XML&quot;, 450))
</code></pre>
</div>
<div class="cell markdown">
<h2 id="step-1-exploring-data-first-xml-parsing-in-scala"><a class="header" href="#step-1-exploring-data-first-xml-parsing-in-scala">Step 1: Exploring data first: xml parsing in scala</a></h2>
<p>But, first let's understand the data and its structure.</p>
<p><strong>Step 0: Dowloading and Loading Data (The Full Dataset)</strong> should have been done already with data in dbfs alread.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val raw = sc.wholeTextFiles(&quot;dbfs:/datasets/obo/tei/ordinarysAccounts/OA17070912.xml&quot;)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val raw = sc.wholeTextFiles(&quot;dbfs:/datasets/obo/tei/sessionsPapers/17280717.xml&quot;) // has data on crimes and punishments
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//val oboTest = sc.wholeTextFiles(&quot;dbfs:/datasets/obo/tei/ordinaryAccounts/OA1693072*.xml&quot;)
val xml = raw.map( x =&gt; x._2 )
val x = xml.take(1)(0) // getting content of xml file as a string
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val elem = scala.xml.XML.loadString(x)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">elem
</code></pre>
</div>
<div class="cell markdown">
<h2 id="quick-preparation"><a class="header" href="#quick-preparation">Quick Preparation</a></h2>
<h4 id="some-examples-to-learn-xml-and-scala-in-a-hurry"><a class="header" href="#some-examples-to-learn-xml-and-scala-in-a-hurry">Some examples to learn xml and scala in a hurry</a></h4>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val p = new scala.xml.PrettyPrinter(80, 2)

p.format(elem)
</code></pre>
</div>
<div class="cell markdown">
<h3 id="better-examples"><a class="header" href="#better-examples">Better examples:</a></h3>
<p>http://alvinalexander.com/scala/how-to-extract-data-from-xml-nodes-in-scala</p>
<p>http://alvinalexander.com/scala/scala-xml-xpath-example</p>
<h4 id="more-advanced-topics"><a class="header" href="#more-advanced-topics">More advanced topics:</a></h4>
<p>https://alvinalexander.com/scala/serializing-deserializing-xml-scala-classes</p>
<h4 id="xml-to-json-if-you-want-to-go-this-route"><a class="header" href="#xml-to-json-if-you-want-to-go-this-route">XML to JSON, if you want to go this route:</a></h4>
<p>https://stackoverflow.com/questions/9516973/xml-to-json-with-scala</p>
</div>
<div class="cell markdown">
<h2 id="our-parsing-problem"><a class="header" href="#our-parsing-problem">Our Parsing Problem</a></h2>
<p>Let's dive deep on this data right away. See links above to learn xml more systematically to be able to parse other subsets of the data for your own project.</p>
<p>For now, we will jump in to parse the input data of counts used in <a href="http://lamastex.org/preprints/20150828_civilizingProcOBO.pdf">Jasper Mackenzie, Raazesh Sainudiin, James Smithies and Heather Wolffram, A nonparametric view of the civilizing process in London's Old Bailey, Research Report UCDMS2015/1, 32 pages, 2015</a>.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">(elem \\ &quot;div0&quot;).map(Node =&gt; (Node \ &quot;@type&quot;).text) // types of div0 node, the singleton root node for the file
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">(elem \\ &quot;div1&quot;).map(Node =&gt; (Node \ &quot;@type&quot;).text) // types of div1 node
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">(elem \\ &quot;div1&quot;)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">(elem \\ &quot;div1&quot;).filter(Node =&gt; ((Node \ &quot;@type&quot;).text == &quot;trialAccount&quot;))
                 .map(Node =&gt; (Node \ &quot;@type&quot;, Node \ &quot;@id&quot; ))
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val trials = (elem \\ &quot;div1&quot;).filter(Node =&gt; ((Node \ &quot;@type&quot;).text == &quot;trialAccount&quot;))
                 .map(Node =&gt; (Node \ &quot;@type&quot;, Node \ &quot;@id&quot;, (Node \\ &quot;rs&quot; \\ &quot;interp&quot;).map( n =&gt; ((n \\ &quot;@type&quot;).text, (n \\ &quot;@value&quot;).text ))))
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val wantedFields = Seq(&quot;verdictCategory&quot;,&quot;punishmentCategory&quot;,&quot;offenceCategory&quot;).toSet
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val trials = (elem \\ &quot;div1&quot;).filter(Node =&gt; ((Node \ &quot;@type&quot;).text == &quot;trialAccount&quot;))
                 .map(Node =&gt; ((Node \ &quot;@type&quot;).text, (Node \ &quot;@id&quot;).text, (Node \\ &quot;rs&quot; \\ &quot;interp&quot;)
                                                               .filter(n =&gt; wantedFields.contains( (n \\ &quot;@type&quot;).text))
                                                               .map( n =&gt; ((n \\ &quot;@type&quot;).text, (n \\ &quot;@value&quot;).text ))))
</code></pre>
</div>
<div class="cell markdown">
<p>Since there can be more than one defendant in a trial, we need to reduce by key as follows.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">def reduceByKey(collection: Traversable[Tuple2[String, Int]]) = {    
    collection
      .groupBy(_._1)
      .map { case (group: String, traversable) =&gt; traversable.reduce{(a,b) =&gt; (a._1, a._2 + b._2)} }
  }
</code></pre>
</div>
<div class="cell markdown">
<p>Let's process the coarsest data on the trial as json strings.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val trials = (elem \\ &quot;div1&quot;).filter(Node =&gt; ((Node \ &quot;@type&quot;).text == &quot;trialAccount&quot;))
                 .map(Node =&gt; {val trialId = (Node \ &quot;@id&quot;).text;
                               val trialInterps = (Node \\ &quot;rs&quot; \\ &quot;interp&quot;)
                                                                 .filter(n =&gt; wantedFields.contains( (n \\ &quot;@type&quot;).text))
                                                                 //.map( n =&gt; ((n \\ &quot;@type&quot;).text, (n \\ &quot;@value&quot;).text ));
                                                                 .map( n =&gt; ((n \\ &quot;@value&quot;).text , 1 ));
                               val trialCounts = reduceByKey(trialInterps).toMap;
                               //(trialId, trialInterps, trialCounts)
                               scala.util.parsing.json.JSONObject(trialCounts updated (&quot;id&quot;, trialId))
                              })
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">trials.foreach(println)
</code></pre>
</div>
<div class="cell markdown">
<h2 id="step-2-extract-transform-and-load-xml-files-to-get-dataframe-of-counts"><a class="header" href="#step-2-extract-transform-and-load-xml-files-to-get-dataframe-of-counts">Step 2: Extract, Transform and Load XML files to get DataFrame of counts</a></h2>
<p>We have played enough (see <strong>Step 1: Exploring data first: xml parsing in scala</strong> above first) to understand what to do now with our xml data in order to get it converted to counts of crimes, verdicts and punishments.</p>
<p>Let's parse the xml files and turn into Dataframe in one block.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val rawWTF = sc.wholeTextFiles(&quot;dbfs:/datasets/obo/tei/sessionsPapers/*.xml&quot;) // has all data on crimes and punishments
val raw = rawWTF.map( x =&gt; x._2 )
val trials = raw.flatMap( x =&gt; { 
                       val elem = scala.xml.XML.loadString(x);
                       val outJson = (elem \\ &quot;div1&quot;).filter(Node =&gt; ((Node \ &quot;@type&quot;).text == &quot;trialAccount&quot;))
                           .map(Node =&gt; {val trialId = (Node \ &quot;@id&quot;).text;
                               val trialInterps = (Node \\ &quot;rs&quot; \\ &quot;interp&quot;)
                                                                 .filter(n =&gt; wantedFields.contains( (n \\ &quot;@type&quot;).text))
                                                                 //.map( n =&gt; ((n \\ &quot;@type&quot;).text, (n \\ &quot;@value&quot;).text ));
                                                                 .map( n =&gt; ((n \\ &quot;@value&quot;).text , 1 ));
                               val trialCounts = reduceByKey(trialInterps).toMap;
                               //(trialId, trialInterps, trialCounts)
                               scala.util.parsing.json.JSONObject(trialCounts updated (&quot;id&quot;, trialId)).toString()
                              })
  outJson
})
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">dbutils.fs.rm(&quot;dbfs:/datasets/obo/processed/trialCounts&quot;,recurse=true) // let's remove the files from the previous analysis
trials.saveAsTextFile(&quot;dbfs:/datasets/obo/processed/trialCounts&quot;) // now let's save the trial counts - aboout 220 seconds to pars all data and get counts
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(dbutils.fs.ls(&quot;dbfs:/datasets/obo/processed/trialCounts&quot;))
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val trialCountsDF = sqlContext.read.json(&quot;dbfs:/datasets/obo/processed/trialCounts&quot;)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">trialCountsDF.printSchema
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">trialCountsDF.count // total number of trials = 197751
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(trialCountsDF)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val trDF = trialCountsDF.na.fill(0) // filling nulls with 0
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(trDF)
</code></pre>
</div>
<div class="cell markdown">
<p>This is already available as the following csv file:</p>
<ul>
<li><a href="http://lamastex.org/datasets/public/OldBailey/oboOffencePunnishmentCountsFrom-sds-2-2-ApacheSparkScalaProcessingOfOBOXMLDoneByRaazOn20180405.csv">http://lamastex.org/datasets/public/OldBailey/oboOffencePunnishmentCountsFrom-sds-2-2-ApacheSparkScalaProcessingOfOBOXMLDoneByRaazOn20180405.csv</a></li>
</ul>
<p>Please cite this URL if you use this data or the Apache licensed codes in the databricks notebook above for your own non-commerical analysis:</p>
<ul>
<li><a href="http://lamastex.org/datasets/public/OldBailey/">http://lamastex.org/datasets/public/OldBailey/</a></li>
</ul>
<p>Raazesh Sainudiin generated this header <strong>Old bailey Processing in Apache Spark</strong> on Thu Apr 5 18:22:43 CEST 2018 in Uppsala, Sweden.</p>
</div>
<div class="cell markdown">
<h2 id="step-0-dowloading-and-loading-data-the-full-dataset"><a class="header" href="#step-0-dowloading-and-loading-data-the-full-dataset">Step 0: Dowloading and Loading Data (The Full Dataset)</a></h2>
<p>First we will be downloading data from <a href="http://lamastex.org/datasets/public/OldBailey/index.html">http://lamastex.org/datasets/public/OldBailey/index.html</a>.</p>
<p>The steps below need to be done once for a give shard!</p>
<p>You can download the tiny dataset <code>obo-tiny/OB-tiny_tei_7-2_CC-BY-NC.zip</code> <strong>to save time and space in db CE</strong></p>
<p><strong>Optional TODOs:</strong></p>
<ul>
<li>one could just read the zip files directly (see week 10 on Beijing taxi trajectories example from the scalable-data-science course in 2016 or read 'importing zip files' in the Guide).</li>
<li>one could just download from s3 directly</li>
</ul>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-sh"># if you want to download the tiny dataset
wget https://raw.githubusercontent.com/raazesh-sainudiin/scalable-data-science/master/datasets/obo-tiny/OB-tiny_tei_7-2_CC-BY-NC.zip
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-sh"># this is the full dataset - necessary for a project on this dataset
wget http://lamastex.org/datasets/public/OldBailey/OB_tei_7-2_CC-BY-NC.zip
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-sh">pwd &amp;&amp; ls -al
</code></pre>
</div>
<div class="cell markdown">
<p>Make sure you comment/uncomment the right files depending on wheter you have downloaded the tiny dataset or the big one.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-sh">unzip OB-tiny_tei_7-2_CC-BY-NC.zip
#unzip OB_tei_7-2_CC-BY-NC.zip
</code></pre>
</div>
<div class="cell markdown">
<p>Let's put the files in dbfs.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">dbutils.fs.mkdirs(&quot;dbfs:/datasets/obo/tei&quot;) //need not be done again!
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//dbutils.fs.rm(&quot;dbfs:/datasets/obo/tei&quot;,true)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-sh">ls 
#ls obo-tiny/tei
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala"> dbutils.fs.cp(&quot;file:/databricks/driver/obo-tiny/tei&quot;, &quot;dbfs:/datasets/obo/tei/&quot;,recurse=true) // already done and it takes 1500 seconds - a while!
 //dbutils.fs.cp(&quot;file:/databricks/driver/tei&quot;, &quot;dbfs:/datasets/obo/tei/&quot;,recurse=true) // already done and it takes 19 minutes - a while!
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//dbutils.fs.rm(&quot;dbfs:/datasets/tweets&quot;,true) // remove files to make room for the OBO dataset
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(dbutils.fs.ls(&quot;dbfs:/datasets/&quot;))
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(dbutils.fs.ls(&quot;dbfs:/datasets/obo/tei/&quot;))
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">util.Properties.versionString // check scala version
</code></pre>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../contents/000_1-sds-3-x/010_wikipediaClickStream_01ETLEDA.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../contents/000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../contents/000_1-sds-3-x/010_wikipediaClickStream_01ETLEDA.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../contents/000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
