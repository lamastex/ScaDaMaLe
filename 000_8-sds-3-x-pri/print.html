<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>sds-3.x/ScaDaMaLe</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="scroll-mdbook-outputs.css">
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="contents/000_8-sds-3-x-pri/01_privacyPreservingDataScience.html">01_privacyPreservingDataScience</a></li><li class="chapter-item expanded affix "><a href="contents/000_8-sds-3-x-pri/02_privacyPreservingDataScience_pseudonomyzation.html">02_privacyPreservingDataScience_pseudonomyzation</a></li><li class="chapter-item expanded affix "><a href="contents/000_8-sds-3-x-pri/03_privacyPreservingDataScience_Differential_Privacy.html">03_privacyPreservingDataScience_Differential_Privacy</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">sds-3.x/ScaDaMaLe</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div class="cell markdown">
<h1 id="a-hrefhttpslamastexgithubioscalable-data-sciencesds2xsds-2x-scalable-data-engineering-sciencea"><a class="header" href="#a-hrefhttpslamastexgithubioscalable-data-sciencesds2xsds-2x-scalable-data-engineering-sciencea"><a href="https://lamastex.github.io/scalable-data-science/sds/2/x/">SDS-2.x, Scalable Data Engineering Science</a></a></h1>
</div>
<div class="cell markdown">
<h3 id="a-hrefhttpswwwlinkedincominchristoffer-lc3a5ngstrc3b6m-7a460514bby-christoffer-långströma"><a class="header" href="#a-hrefhttpswwwlinkedincominchristoffer-lc3a5ngstrc3b6m-7a460514bby-christoffer-långströma"><a href="https://www.linkedin.com/in/christoffer-l%C3%A5ngstr%C3%B6m-7a460514b/">by Christoffer Långström</a></a></h3>
<p>This notebook series will give an overview on the current state of privacy protection mechanisms, both in terms of data sanitation (which involves enforces privacy guarantees on the data itself) as well as algorithmic sanitation, which involves privacy inducing mechanism in statistical learning algorithms. This is part of a masters project in applied mathematics by Christoffer Långström under the supervision of Raazeesh Sainudiin and is partly inspired by the great work presented in the following talk at the 2018 Spark AI summit by Sim Semeonov &amp; Slater Victoroff.</p>
<p>This work aims to recreate, elaborate &amp; extend the material presented above, going through the current state of privacy in statistical learning, with both technical &amp; mathematical perspectives. Later, a full reconstruction of the Databricks notebooks presented above will be given with comments and explanations in order to facilitate use.</p>
</div>
<div class="cell markdown">
<p>Protecting the privacy of individuals included in a data set is both highly important &amp; suprisingly difficult. The importance is clear; sensitive information being leaked to adversarial parties can be harmful to anyone with personal information contained in a data set (which in this age is almost everyone), yet institutions such as medical researchers &amp; academics are in great need of such data. Thankfully, personally identifiable information (here on referred to as pii) such as names and social numbers are rarely of any interest to the research, and is merely used by the data collector to ensure that the data corresponds to an actual individual. A solution could then be to use Pseudonomyous identifiers, where unique identifier is generated for each data entry in such a way that one cannot rediscover the original identity from the data set alone. This is the main focus in the talk by Simenov &amp; Victoroff, which is described in part 2.</p>
<p>As it turns out however, this is not the only privacy measure needed. In a very interesting case study, <a href="http://www.cs.pomona.edu/%7Esara/classes/cs190-fall12/k-anonymity.pdf">Latanya Sweeney showed</a> that given anonymised medical records, along with publicly avaliable voter registration records, she was able to discover medical information (such as conditions, treatments &amp; medications prescribed) regarding the then governor of Massachusetts. She did this by a join attack; the voter registration data contained name, address, ZIP code, birth date, and gender of each voter and in the medical data there was only one person with the governors ZIP code, gender and date of birth. This introduces the notion of quasi-identifiers, pieces of information that while not sensitive on its own, can be combined together with other pieces of non-sensitive data to reveal sensitive information. This can be adressed through the concepts of k-anonymity and some derivative methods that introduce &quot;reasonable doubt&quot; to the identity of the person behind the data.</p>
<p>Further, we will take a look at differential privacy, which adresses the problem presented in example 1, that inclusion/removal is itself privacy compromising. Differential privacy aims to provide a statistical framework to measure how private an estimator is, more specifically how sensitive the output of an estimation procedure is to the inclusion/removal of an entry in the set. The main approach to increasing the privacy of a given estimator is by introducing some stochastic distortion to the computations to obtain a desired degree of privacy. This approach is not without its flaws; most notably how it decreases the accuracy of estimators.</p>
</div>
<div class="cell markdown">
<h3 id="what-the-gdpr-requires-from-data-scientists"><a class="header" href="#what-the-gdpr-requires-from-data-scientists">What The GDPR Requires From Data Scientists:</a></h3>
<p>The GDPR now puts it into law that the holder and utilizer of data is responisble for its safe keeping by enforcing certain practices regarding the storage of the data. In practice, this is broken down into 3* categories.</p>
<h4 id="1-data-protection--records-of-processing"><a class="header" href="#1-data-protection--records-of-processing">1) Data Protection &amp; Records of Processing</a></h4>
<p>The GDPR specifes that by design data must be protected and encryption should be done locally, not utilizing any outside service. This will be relevant in the process of pseudonymization decribed below. Whenever the data is processed, records must be kept of the processing done, its purpose, what data was utilized and a projected time plan for how long the result will be used.</p>
<p>Key Points:</p>
<ul>
<li>Encryption/decryption must be done locally</li>
<li>Keep records of what you used the data for; <a href="https://gdpr-info.eu/issues/records-of-processing-activities/">see</a></li>
</ul>
<h5 id="details"><a class="header" href="#details">Details</a></h5>
<p>That part is in reference to this line &quot; In particular, such measures shall ensure that by default personal data are not made accessible without the individual's intervention to an indefinite number of natural persons.&quot; from Article 25: - https://www.privacy-regulation.eu/en/article-25-data-protection-by-design-and-by-default-GDPR.htm</p>
<p>In a report by ENISA (Eu Network and information security agency) they make the explicit claim that you should do local encryption (p. 20) - https://web.archive.org/web/20170405171636/https://www.enisa.europa.eu/publications/privacy-and-data-protection-by-design</p>
<h4 id="2-pseudonymization--the-right-of-access"><a class="header" href="#2-pseudonymization--the-right-of-access">2) Pseudonymization &amp; The Right Of Access</a></h4>
<h5 id="--direct-identifiers"><a class="header" href="#--direct-identifiers">- Direct Identifiers</a></h5>
<img src="http://i.imgur.com/pLIOVvp.png" alt="drawing" width="600">
<ul>
<li>An identifier is any attribute that can be used to directly identify an individual in your data set, such as names &amp; social numbers.</li>
<li>The GDPR stipulates that the data holder must provide proper protection on identifiers in the form of pseudonymization.</li>
</ul>
<p>The purpose of pseudonymization is to adress the fact that rarely do data holders need direct identifiers to perform analysis, and so aims to enforce that each such identifier is to be replaced with a pseudonym, useful only to distinguish members of a data set from each other. Another principle of the law is that any individual in the data set should at any time be able to query the holder on what information is being kept about them. Combining these two principles, it becomes clear that the pseudonymization must be caried out in such a way that it is effective, but also (partially) reversible, at least to an extent that given an identifier we can find what information is being kept on this subject.</p>
<h4 id="3-the-right-of-erasure"><a class="header" href="#3-the-right-of-erasure">3) The Right Of Erasure</a></h4>
<p>A data subject also has the right to at any time request for their data to be removed from the data set. Again, this requires that any pseudonomyzation must be query-able to find a certain individual, and that the pseudonyms cannot be purely destructive. As we well investigate later, this act of removal poses its own risks in terms of privacy exposure as the below example demonstrates.</p>
<ul>
<li>Note: The right of erasure is a limited right, meaning that the data holder does not always have to comply.</li>
</ul>
<h5 id="when-do-we-not-need-to-delete-the-data"><a class="header" href="#when-do-we-not-need-to-delete-the-data">When do we <em>not</em> need to delete the data?</a></h5>
<p>1) The personal data your company/organisation holds is needed to exercise the right of freedom of expression</p>
<p>2) There is a legal obligation to keep that data</p>
<p>3) For reasons of public interest (for example public health, scientific, statistical or historical research purposes)</p>
<ul>
<li>
<p>For more details see: (https://gdpr-info.eu/art-17-gdpr/) and <a href="https://ec.europa.eu/info/law/law-topic/data-protection/reform/rules-business-and-organisations/dealing-citizens/do-we-always-have-delete-personal-data-if-person-asks_en">Do we always have to delete personal data if a person asks?</a></p>
</li>
<li>
<p>Notice that &quot;Commercial Purposes&quot; does not fit in to any of these options.</p>
</li>
</ul>
<h5 id="example-of-privacy-concerns-with-erasure"><a class="header" href="#example-of-privacy-concerns-with-erasure">Example of Privacy Concerns With Erasure:</a></h5>
<p>Suppose there is a data set containing individuals exercise habits, categorizing them as &quot;runners&quot; or &quot;non-runners&quot;. You request the number of runners in the set, and recieve the answer 49. This in itself does not give any information on any individual in the set. Then, Alice requests to have her data removed from the set. You run the query again, and discover that there are now only 48 runners in the set, and so you have obtained information regarding Alice just by her wanting her data removed. This problem leads to the subject of query-level privacy and differential privacy which will be discussed later.</p>
</div>
<div class="cell code" execution_count="1" scrolled="auto">
<div class="output execute_result html_result" execution_count="1">
<iframe 
 src="https://en.wikipedia.org/wiki/General_Data_Protection_Regulation"
 width="95%" height="350"
 sandbox>
  <p>
    <a href="http://spark.apache.org/docs/latest/index.html">
      Fallback link for browsers that, unlikely, don't support frames
    </a>
  </p>
</iframe>
</div>
</div>
<div class="cell markdown">
<ul>
<li>
<p><a href="https://ec.europa.eu/commission/priorities/justice-and-fundamental-rights/data-protection/2018-reform-eu-data-protection-rules_en">EU Offical Site On GDPR</a></p>
</li>
<li>
<p><a href="https://www.datainspektionen.se/lagar--regler/dataskyddsforordningen/">Swedish Agency Datainspektionen on GDPR</a></p>
</li>
<li>
<p><a href="https://eugdpr.org/">eugdpr.org (Unoffical Resource On GDPR for Organizations &amp; Companies)</a></p>
</li>
</ul>
</div>
<div class="cell markdown">
<h4 id="4-the-right-of-explanation"><a class="header" href="#4-the-right-of-explanation">4) The Right Of Explanation*</a></h4>
<p>One concept in the GDPR is that individuals have the right to have it &quot;explained&quot; why decisions made by an algorithm using their data were made. This is relevant to any sort of predictive modelling, and classifiers that places individuals in categories. But what exactly does explanation mean? Does &quot;the algorithm said so&quot; suffice? And how does this affect black box models?</p>
<p>It is already a well known problem in ML applications that models can lack human interpretations, so how can these be used if explainability is required?</p>
<p>Art. 13 of the GDPR:</p>
<blockquote>
<p>&quot;... the controller shall, at the time when personal data are obtained, provide the data subject with the following further information necessary to ensure fair and transparent processing: ...meaningful information about the logic involved, as well as the significance and the envisaged consequences of such processing for the data subject&quot;</p>
</blockquote>
<p>This makes a statement on both the operational workings, &quot;the logic involved&quot; <em>and</em> a more human readable understanding on the meaning of the outcome. Recital 71 (a non-legally binding explanation of the intents of the law) states:</p>
<blockquote>
<p>“(automated processing)... should be subject to suitable safeguards, which should include specific information to the data subject and the right to obtain human intervention, to express his or her point of view, to obtain an explanation of the decision reached after such assessment and to challenge the decision.&quot;</p>
</blockquote>
<p>The intent seems to be to give members of a data set insight in how to their data being processed might affect them, and to give them sufficient information as to be able to make the decision on whether to be included in the set. This leads to a &quot;best practices&quot; checklist for model building:</p>
<p>1) <strong>Technical Report</strong>: Detail from where the data was gathered, and what features where selected for in the model training. For the model(s) used, write them down and the motivation for their choice.</p>
<p>2) <strong>Understand Deployment</strong>: Make a detailed list on what the model will be used for, and the possible (direct) consequences for an individual included in the data set. Study the effects of false positives and false negatives, since this will help you comply with the &quot;significance&quot; part of art. 13.</p>
<p>3) <strong>Educate The Subject</strong>: Together with the above material, list the possible pros/cons of being included in the data set and present the information about the model that best relate to these aspects.</p>
<p>The above list aims to help data scientist comply with any questions they may recieve on the &quot;logic&quot; and &quot;significance&quot; part of art. 13.</p>
</div>
<div class="cell markdown">
<p>See the notebook: https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/806262291388233/586373581842786/4884583572804914/latest.html</p>
</div>
<div class="cell markdown">
<p>See the notebook: https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/806262291388233/365321721214438/4884583572804914/latest.html</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">coming soon
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">coming soon
</code></pre>
</div>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><div class="cell markdown">
<h1 id="a-hrefhttpslamastexgithubioscalable-data-sciencesds2xsds-2x-scalable-data-engineering-sciencea-1"><a class="header" href="#a-hrefhttpslamastexgithubioscalable-data-sciencesds2xsds-2x-scalable-data-engineering-sciencea-1"><a href="https://lamastex.github.io/scalable-data-science/sds/2/x/">SDS-2.x, Scalable Data Engineering Science</a></a></h1>
</div>
<div class="cell markdown">
<h3 id="a-hrefhttpswwwlinkedincominchristoffer-lc3a5ngstrc3b6m-7a460514bchristoffer-långströma"><a class="header" href="#a-hrefhttpswwwlinkedincominchristoffer-lc3a5ngstrc3b6m-7a460514bchristoffer-långströma"><a href="https://www.linkedin.com/in/christoffer-l%C3%A5ngstr%C3%B6m-7a460514b/">Christoffer Långström</a></a></h3>
<p>This section aims to recreate &amp; elaborate on the material presented in the following talk at the 2018 Spark AI summit by Sim Semeonov &amp; Slater Victoroff. Following the advent of the General Data Protection Regulation in the EU, many data scientists are concerned about how this legislation will impact them &amp; what steps they should take in order to protect their data and themselves (as holders of the data) in terms of privacy. Here we focus on two vital aspects of GDPR compliant learning, keeping only pseudonymous identifiers and ensuring that subjects can ask what data is being kept about them.</p>
<p>Watch the video below to see the full talk:</p>
<h2 id="a-hrefhttpsdatabrickscomsessiongreat-models-with-great-privacy-optimizing-ml-ai-under-gdprgreat-models-with-great-privacy-optimizing-ml-and-ai-under-gdpr-by-sim-simeonov--slater-victoroffa"><a class="header" href="#a-hrefhttpsdatabrickscomsessiongreat-models-with-great-privacy-optimizing-ml-ai-under-gdprgreat-models-with-great-privacy-optimizing-ml-and-ai-under-gdpr-by-sim-simeonov--slater-victoroffa"><a href="https://databricks.com/session/great-models-with-great-privacy-optimizing-ml-ai-under-gdpr">Great Models with Great Privacy: Optimizing ML and AI Under GDPR by Sim Simeonov &amp; Slater Victoroff</a></a></h2>
<p><a href="https://www.youtube.com/watch?v=DMzhTY891io"><img src="https://img.youtube.com/vi/DMzhTY891io/0.jpg" alt="XX" /></a></p>
<h3 id="why-do-we-need-pseudonymization"><a class="header" href="#why-do-we-need-pseudonymization">Why Do We Need Pseudonymization?</a></h3>
<p>We want to have identifiers for our data, but personal identifiers (name, social numbers) are to sensitive to store. By storing (strong) pseudonyms we satisfy this requirement. However, the GDPR stipulates that we must be able to answer the question &quot;What data do you have on me?&quot; from any individual in the data set (The Right To Know)</p>
</div>
<div class="cell markdown">
<h4 id="what-we-need"><a class="header" href="#what-we-need">What we need:</a></h4>
<ul>
<li>Consistent serialization of data</li>
<li>Assign a unique ID to each subject in the database</li>
<li>Be able to identify individuals in the set, given their identifiers</li>
<li>Ensure that adversarial parties may not decode these IDs</li>
</ul>
<p>Below is a flowchart showing the process at a high level. Each step is explained later in the guide.</p>
</div>
<div class="cell markdown">
<img src="http://i.imgur.com/jSfzKzq.png" alt="drawing" width="1000"/>
</div>
<div class="cell markdown">
<h3 id="1-data-serialization--randomization"><a class="header" href="#1-data-serialization--randomization">1) Data serialization &amp; Randomization</a></h3>
<p>All data is not formatted equally, and if we wish any processing procedure to be consistent it is important to ensure proper formating. The formating employed here is for a row with fields firstname, lastname, gender, date of birth which is serialized according to the rule: firstname, lastname, gender, dob --&gt; Firstname|Lastname|M/F|YYYY-MM-DD. All of this information will be used in generating the pseudonymous ID, which will help prevent collisions caused by people having the same name, etc.</p>
<p>An important point to be made here is that there should also be some random shuffling of the rows, to decrease further the possibility of adversaries using additional information to divulge sensitive attributes from your table. If the original data set is in alphabetical order, and the output (even thought it has been treated) remains in the same order, we would be vulnerable to attacks if someone compared alphabetical lists of names run through common hash functions.</p>
<h6 id="note"><a class="header" href="#note">Note:</a></h6>
<p>It is often necessary to &quot;fuzzy&quot; the data to some extent in the sense that we decrease the level of accuracy by, for instance, reducing a day of birth to year of birth to decrease the power of quasi-identifiers. As mentioned in part 1, quasi-identifiers are fields that do not individually provide sensitive information but can be utilized together to identify a member of the set. This is discussed further in the next section, for now we implement a basic version of distilling a date of birth to a year of birth. Similar approaches would be to only store initials of names, cities instead of adresses, or dropping information all together (such as genders).</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">import org.apache.spark.sql.functions.rand

// Define the class for pii
case class pii(firstName: String, lastName: String, gender: String, dob: String)

&quot;&quot;&quot;
firstName,lastName,gender,dob
Howard,Philips,M,1890-08-20
Edgar,Allan,M,1809-01-19
Arthur,Ignatius,M,1859-05-22
Mary,Wollstonecraft,F,1797-08-30
&quot;&quot;&quot;
// Read the data from a csv file, then convert to dataset // /FileStore/tables/demo_pii.txt was uploaded
val IDs = spark.read.option(&quot;header&quot;, &quot;true&quot;).csv(&quot;/FileStore/tables/demo_pii.txt&quot;).orderBy(rand())
val ids = IDs.as[pii]
ids.show
 
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>+---------+--------------+------+----------+
|firstName|      lastName|gender|       dob|
+---------+--------------+------+----------+
|     Mary|Wollstonecraft|     F|1797-08-30|
|    Edgar|         Allan|     M|1809-01-19|
|   Arthur|      Ignatius|     M|1859-05-22|
|   Howard|       Philips|     M|1890-08-20|
+---------+--------------+------+----------+

notebook:6: warning: a pure expression does nothing in statement position; you may be omitting necessary parentheses
&quot;&quot;&quot;
^
import org.apache.spark.sql.functions.rand
defined class pii
IDs: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [firstName: string, lastName: string ... 2 more fields]
ids: org.apache.spark.sql.Dataset[pii] = [firstName: string, lastName: string ... 2 more fields]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">import org.apache.spark.sql.functions.rand

// Define the class for pii
case class pii(firstName: String, lastName: String, gender: String, dob: String)

&quot;&quot;&quot;
firstName,lastName,gender,dob
Howard,Philips,M,1890-08-20
Edgar,Allan,M,1809-01-19
Arthur,Ignatius,M,1859-05-22
Mary,Wollstonecraft,F,1797-08-30
&quot;&quot;&quot;
// Read the data from a csv file, then convert to dataset // /FileStore/tables/demo_pii.txt was uploaded
val IDs = spark.read.option(&quot;header&quot;, &quot;true&quot;).csv(&quot;/FileStore/tables/demo_pii.txt&quot;).orderBy(rand())
val ids = IDs.as[pii]
ids.show
 
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>+---------+--------------+------+----------+
|firstName|      lastName|gender|       dob|
+---------+--------------+------+----------+
|   Arthur|      Ignatius|     M|1859-05-22|
|   Howard|       Philips|     M|1890-08-20|
|    Edgar|         Allan|     M|1809-01-19|
|     Mary|Wollstonecraft|     F|1797-08-30|
+---------+--------------+------+----------+

notebook:6: warning: a pure expression does nothing in statement position; you may be omitting necessary parentheses
&quot;&quot;&quot;
^
import org.apache.spark.sql.functions.rand
defined class pii
IDs: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [firstName: string, lastName: string ... 2 more fields]
ids: org.apache.spark.sql.Dataset[pii] = [firstName: string, lastName: string ... 2 more fields]
</code></pre>
</div>
</div>
<div class="cell markdown">
<ol start="2">
<li>Hashing</li>
</ol>
<hr />
<p><a href="https://en.wikipedia.org/wiki/Cryptographic_hash_function">Hash functions</a> apply mathematical algorithms to map abitrary size inputs to fixed length bit string (referred to as &quot;the hash&quot;), and cryptographic hash functions do so in a one-way fashion, i.e it is not possible to reverse this procedure. This makes them good candidates for generating pseudo-IDs since they cannot be reverse engineered but we may easily hash any given identifier and search for it in the database. However, the procedure is not completely satisfactory in terms of safety. Creating good hash functions is very hard, and so commonly a standard hash function is used such as the SHA series. This means unfortunately that anyone can hash common names, passwords, etc using these standard hash functions and then search for them in our database in what is known as a <a href="https://en.wikipedia.org/wiki/Rainbow_table">rainbow attack</a>.</p>
<p>A realistic way of solving this problem is then to encrypt the resulting hashes using a strong encryption algorithm, making them safe for storage by the database holder.</p>
<p>It is important to choose a secure destructive hash function, MD5, SHA-1 and SHA-2 are all vulnerable to <a href="https://en.wikipedia.org/wiki/Length_extension_attack">length extension attacks</a>, for a concrete example see <a href="https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks">here</a>.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">import java.security.MessageDigest
import java.util.Base64
import org.apache.spark.sql._
import org.apache.spark.sql.functions._
import org.apache.spark.sql.types.{IntegerType}

// Perform SHA-256 hashin
def sha_256(in: String): String = {
  val md: MessageDigest = MessageDigest.getInstance(&quot;SHA-256&quot;)  // Instantiate MD with algo SHA-256
  new String(Base64.getEncoder.encode(md.digest(in.getBytes)),&quot;UTF-8&quot;) // Encode the resulting byte array as a base64 string
}

// Generate UDFs from the above functions (not directly evaluated functions) 
// If you wish to call these functions directly then use the names in parenthesis, if you wish to use them in a transform use the udf() names. 
val sha__256 = udf(sha_256 _)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>import java.security.MessageDigest
import java.util.Base64
import org.apache.spark.sql._
import org.apache.spark.sql.functions._
import org.apache.spark.sql.types.IntegerType
sha_256: (in: String)String
sha__256: org.apache.spark.sql.expressions.UserDefinedFunction = UserDefinedFunction(&lt;function1&gt;,StringType,Some(List(StringType)))
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val myStr = &quot;Hello!&quot;  // Input is a string
val myHash = sha_256(myStr)
println(myHash) // The basic function takes a strings and outputs a string of bits in base64 (&quot;=&quot; represents padding becuse of the block based hashes)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>M00Bb3Vc1txYxTqG4YOIL47BT1L7BTRYh8il7dQsh7c=
myStr: String = Hello!
myHash: String = M00Bb3Vc1txYxTqG4YOIL47BT1L7BTRYh8il7dQsh7c=
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// Concantination with a pipe character
val p = lit(&quot;|&quot;)

// Define our serialization rules as a column
val rules: Column = {
    //Use all of the pii for the pseudo ID   
    concat(upper('firstName), p, upper('lastName), p, upper('gender), p,'dob)
}
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>p: org.apache.spark.sql.Column = |
rules: org.apache.spark.sql.Column = concat(upper(firstName), |, upper(lastName), |, upper(gender), |, dob)
</code></pre>
</div>
</div>
<div class="cell markdown">
<h3 id="3-encryption"><a class="header" href="#3-encryption">3) Encryption</a></h3>
<p>Encrypting our hashed IDs via a symmetric key cipher ensures that the data holder can encrypt the hashed identifiers for storage and avoid the hash table attacks discussed above, and can decrypt the values at will to lookup entries. The choice of encryption standard for these implementations is AES-128. When provided with a key (a 128 bit string in our case), the AES algorithm encrypts the data into a sequence of bits, traditionally formated in base 64 binary to text encoding. The key should be pseudorandomly generated, which is a standard functionality in Java implementions.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">import javax.crypto.KeyGenerator
import javax.crypto.Cipher
import javax.crypto.spec.SecretKeySpec

var myKey: String = &quot;&quot;

// Perform AES-128 encryption
def encrypt(in: String): String = {
  val raw = KeyGenerator.getInstance(&quot;AES&quot;).generateKey.getEncoded()      //Initiates a key generator object of type AES, generates the key, and encodes &amp; returns the key 
  myKey = new String(Base64.getEncoder.encode(raw),&quot;UTF-8&quot;)       //String representation of the key for decryption
  val skeySpec = new SecretKeySpec(raw, &quot;AES&quot;)      //Creates a secret key object from our generated key
  val cipher = Cipher.getInstance(&quot;AES&quot;)      //Initate a cipher object of type AES
  cipher.init(Cipher.ENCRYPT_MODE, skeySpec)  // Initialize the cipher with our secret key object, specify encryption
  new String(Base64.getEncoder.encode(cipher.doFinal(in.getBytes)),&quot;UTF-8&quot;)  // Encode the resulting byte array as a base64 string
}

// Perform AES-128 decryption
def decrypt(in: String): String = {
  val k = new SecretKeySpec(Base64.getDecoder.decode(myKey.getBytes), &quot;AES&quot;)    //Decode the key from base 64 representation
  val cipher = Cipher.getInstance(&quot;AES&quot;)       //Initate a cipher object of type AES
  cipher.init(Cipher.DECRYPT_MODE, k)       // Initialize the cipher with our secret key object, specify decryption
  new String((cipher.doFinal(Base64.getDecoder.decode(in))),&quot;UTF-8&quot;)      // Encode the resulting byte array as a base64 string
}

val myEnc = udf(encrypt _)
val myDec = udf(decrypt _)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>import javax.crypto.KeyGenerator
import javax.crypto.Cipher
import javax.crypto.spec.SecretKeySpec
myKey: String = &quot;&quot;
encrypt: (in: String)String
decrypt: (in: String)String
myEnc: org.apache.spark.sql.expressions.UserDefinedFunction = UserDefinedFunction(&lt;function1&gt;,StringType,Some(List(StringType)))
myDec: org.apache.spark.sql.expressions.UserDefinedFunction = UserDefinedFunction(&lt;function1&gt;,StringType,Some(List(StringType)))
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val secretStr = encrypt(myStr) //Output is a bit array encoded as a string in base64
println(&quot;Encrypted: &quot;.concat(secretStr))  
println(&quot;Decrypted: &quot;.concat(decrypt(secretStr)))
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>Encrypted: qrg96tS/xhbWAKymqZQd+w==
Decrypted: Hello!
secretStr: String = qrg96tS/xhbWAKymqZQd+w==
</code></pre>
</div>
</div>
<div class="cell markdown">
<h3 id="4-define-mappings"><a class="header" href="#4-define-mappings">4) Define Mappings</a></h3>
<p>Now we are ready to define the mappings that make up our pseudonymization procedure:</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val psids = {
  //Serialize -&gt; Hash -&gt; Encrypt
    myEnc(
       sha__256(
        rules)
  ).as(s&quot;pseudoID&quot;)       
}
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>psids: org.apache.spark.sql.Column = UDF(UDF(concat(upper(firstName), |, upper(lastName), |, upper(gender), |, dob))) AS `pseudoID`
</code></pre>
</div>
</div>
<div class="cell markdown">
<h5 id="next-we-define-what-we-mean-by-a-quasi-id-column-and-fuzzy-the-data-by-reducing-the-date-of-birth-into-a-year-of-birth"><a class="header" href="#next-we-define-what-we-mean-by-a-quasi-id-column-and-fuzzy-the-data-by-reducing-the-date-of-birth-into-a-year-of-birth">Next, we define what we mean by a quasi-id column, and &quot;fuzzy&quot; the data by reducing the date of birth into a year of birth</a></h5>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val quasiIdCols: Seq[Column] = Seq(
  //Fuzzify data
  'gender,
  'dob.substr(1, 4).cast(IntegerType).as(&quot;yob&quot;)
)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>quasiIdCols: Seq[org.apache.spark.sql.Column] = List(gender, CAST(substring(dob, 1, 4) AS INT) AS `yob`)
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// Here we define the PII transformation to be applied to our dataset, which outputs a dataframe modified according to our specifications. 

def removePII(ds: Dataset[_]): DataFrame = 
  ds.toDF.select(quasiIdCols ++ Seq(psids): _*)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>removePII: (ds: org.apache.spark.sql.Dataset[_])org.apache.spark.sql.DataFrame
</code></pre>
</div>
</div>
<div class="cell markdown">
<h3 id="5-pseudonymize-the-data"><a class="header" href="#5-pseudonymize-the-data">5) Pseudonymize the Data</a></h3>
<p>Here we perform the actual transformation, saving the output in a new dataframe. This is the data we should be storing in our databases for future use.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val masterIds = ids.transform(removePII)
display(masterIds)
</code></pre>
<div class="output execute_result tabular_result" execution_count="1">
<table>
<thead>
<tr class="header">
<th>gender</th>
<th>yob</th>
<th>pseudoID</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>M</td>
<td>1859.0</td>
<td>b48AjgbsA4w7SWIhkpBVVVYORZksKJeCF/CF/xIdGkmneOYVr4HlKeh2N5YjE24M</td>
</tr>
<tr class="even">
<td>M</td>
<td>1890.0</td>
<td>04AG3WaElWdPv7g6thR7KqiPcrDD6uwGzMvNyzkmbwXvw5b5X10bZdliUr4Ts0cx</td>
</tr>
<tr class="odd">
<td>M</td>
<td>1809.0</td>
<td>7sJpA5IjhYN5C+nqDCf5pT602OhTvClenIJ1DX3HeMLkc1JoAuplHNguAK1S8WAG</td>
</tr>
<tr class="even">
<td>F</td>
<td>1797.0</td>
<td>bOc7c9e3bl5tF9EdlEFJmtnmv0HSUC+vEx3fo4v3LS4goGRx47/iQpT8ARrTyvuq</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell markdown">
<h3 id="6-partner-specific-encoding"><a class="header" href="#6-partner-specific-encoding">6) Partner Specific Encoding</a></h3>
<p>In practice it may be desirable to, as the trusted data holder, send out partial data sets to different partners. Here, the main concern is that if we send two partial data sets to two different partners, those two partners may merge their data sets together without our knowledge, and obtain more information than we intended. This issue is discussed further in the next part, where attacks to divulge sensitive information from pseudonymized data sets is handled, but for now we will show how to limit the dangers using partner specific encoding.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// If we do not need partner specific passwords, it is sufficient to simply call the transform twice since the randomized key will be different each time. 

val partnerIdsA = ids.transform(removePII)
val partnerIdsB = ids.transform(removePII)

display(partnerIdsB)
</code></pre>
<div class="output execute_result tabular_result" execution_count="1">
<table>
<thead>
<tr class="header">
<th>gender</th>
<th>yob</th>
<th>pseudoID</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>M</td>
<td>1859.0</td>
<td>ZXfGvFpVfvrsqYcWlyKZ/R9OZIgGq7IAeaN4ZUdVEOkwsOCr0iLZkyYpNF9s+ycx</td>
</tr>
<tr class="even">
<td>M</td>
<td>1890.0</td>
<td>npQ386CleB7dL3BM9E513SPzvd9jMFlTtN0rC27m6eFOTwPsDrUGJmZ9L4DgAN58</td>
</tr>
<tr class="odd">
<td>M</td>
<td>1809.0</td>
<td>1Gyh7ynu2lwz43YfCyiu9jFiONehWZF11qzM1d9g2XWTl8y1VXpn80IJ29jEUHA8</td>
</tr>
<tr class="even">
<td>F</td>
<td>1797.0</td>
<td>zi0ZYjYUX5g254CRANgeLtwt4zZDz9n9DrQ8h5tsLBrQQXSSr/P1T0zpJxxJHdXD</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(partnerIdsA)
</code></pre>
<div class="output execute_result tabular_result" execution_count="1">
<table>
<thead>
<tr class="header">
<th>gender</th>
<th>yob</th>
<th>pseudoID</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>M</td>
<td>1859.0</td>
<td>3XwROq3GyPYJdiO3ZN+OuUowX4jRix6J+NNmkEMuOqTu2k3QssXp9b7Bi0O/LXAZ</td>
</tr>
<tr class="even">
<td>M</td>
<td>1890.0</td>
<td>XwLU5HKLQFGefeq2EX+GwhF9tEyeU/Q6/aKgy8ZMYJ0AD/3aBPyi1/k/NrP8Su1j</td>
</tr>
<tr class="odd">
<td>M</td>
<td>1809.0</td>
<td>E3RQ+PodF86W4AOMRcoNL1OoXDB1PmFsyXj+ynlK6rl0XkJFeDz8nfVYAX7+6MHu</td>
</tr>
<tr class="even">
<td>F</td>
<td>1797.0</td>
<td>wbS+eZ4QgpW6SONneBm9+jTPHE2J3bWba/ZwL3+iWZo5K+kElhmFm7DjpFyAmp37</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell markdown">
<p>The data set above is now pseudonymized, but is still vulnerable to other forms of privacy breaches. For instance, since there is only one female in the set, an adversary who only knows that their target is in the set and is a woman, her information is still subject to attacks. For more information see <a href="https://en.wikipedia.org/wiki/K-anonymity">K-anonymity</a>, see also the <a href="https://epic.org/privacy/reidentification/Sweeney_Article.pdf">original paper</a></p>
</div>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><div class="cell markdown">
<h1 id="a-hrefhttpslamastexgithubioscalable-data-sciencesds2xsds-2x-scalable-data-engineering-sciencea-2"><a class="header" href="#a-hrefhttpslamastexgithubioscalable-data-sciencesds2xsds-2x-scalable-data-engineering-sciencea-2"><a href="https://lamastex.github.io/scalable-data-science/sds/2/x/">SDS-2.x, Scalable Data Engineering Science</a></a></h1>
</div>
<div class="cell markdown">
<h6 id="by-a-hrefhttpswwwlinkedincominchristoffer-lc3a5ngstrc3b6m-7a460514bchristoffer-långströma"><a class="header" href="#by-a-hrefhttpswwwlinkedincominchristoffer-lc3a5ngstrc3b6m-7a460514bchristoffer-långströma">by <a href="https://www.linkedin.com/in/christoffer-l%C3%A5ngstr%C3%B6m-7a460514b/">Christoffer Långström</a></a></h6>
<p>This is part 3 of the in a series of notebooks discussing different aspects on privacy preserving methods in data science.</p>
<p>Differential privacy, originally proposed by Cynthia Dwork et. al (2006) treats the problem of privacy from the perspective that simply being included in a data set is a risk. The solution proposed through diffential privacy is to make it so that a data set that contains a certain individual is not meaningfully differentiable from the same data set with that person removed.</p>
<p>The proposal was to make it so that a random algorithm could be considered epsilon diff. private if the distribution of the estimator does not &quot;change much&quot; with the inclusion/exclusion of any particular individual, with epsilon being the &quot;privacy factor&quot; that quantifies to what extent the distributions differ. See below for more details.</p>
<p>The advantage of this approach is that we can now quantify the degree of privacy of a random algorithm, and start to develop methods that enforce a desired level of privacy in an algorithm. Further, there is research being done (Duchi et. al) on <em>local</em> differential privacy, where the true data is kept hidden from even the data scientist working on it, by applying differentially private mechanisms to the data, before any statistics is computed. The type of privacy preserving mechanism that is applied depends on the application, where min/max optimal estimators are found for several canonical statistical problems.</p>
<h3 id="links"><a class="header" href="#links">Links:</a></h3>
<ul>
<li>
<p>Introduction to DP in the context of network protocols:
<a href="https://www.youtube.com/watch?v=PlSX-o36Wus&amp;feature=youtu.be&amp;t=3809">Diffential Privacy at IETF104 by Amelia Andersdotter and Christoffer Långström</a></p>
</li>
<li>
<p>Locally private statistical procedures:
<a href="https://arxiv.org/abs/1604.02390">Minimax Optimal Procedures for Locally Private Estimation</a></p>
</li>
<li>
<p>Original DP paper:
<a href="http://people.csail.mit.edu/asmith/PS/sensitivity-tcc-final.pdf">Cynthia Dwork et. al</a></p>
</li>
</ul>
</div>
<div class="cell code" execution_count="1" scrolled="auto">
<div class="output execute_result html_result" execution_count="1">
<iframe 
 src="https://en.wikipedia.org/wiki/Differential_privacy#Definition_of_ε-differential_privacy"
 width="95%" height="350"
 sandbox>
  <p>
    <a href="http://spark.apache.org/docs/latest/index.html">
      Fallback link for browsers that, unlikely, don't support frames
    </a>
  </p>
</iframe>
</div>
</div>
<div class="cell markdown">
<p>One of the first suggested approaches to enforcing e-differential privacy was by introducing &quot;noise&quot; to the ouput of estimators. This approach works as thus: For a dataset <em>X</em>, compute the statistic <em>T(X)</em>, generate some noise <em>W</em>, return <em>T(X) + W</em> as the result. If <em>W</em> is symmetric noise, and chosen in such a way that it does not greatly distort the data, the goal is to achieve reasonably good estimates that cannot be meaningfully reversed engineered to reveal information on the people included in the data set.</p>
<h4 id="the-laplace-mechanism"><a class="header" href="#the-laplace-mechanism">The Laplace Mechanism</a></h4>
<p>This approach to adding noisy data involves adding samples from a standard laplace distribution, with the scale parameter chosen depending on the sensitivity of the data and the desired privacy level. The laplace distribution is a symmetric &quot;double exponential&quot; distribution with slim tails and a sharp center, here taken to be at the origin. The algorithm for applying laplace noise to a data set is as follows:</p>
<p>Let <em>D</em> be a data set and <em>T</em> a statistic to be computed, and <em>epsilon</em> the desired degree of privacy. * Compute the sensitivity \(\Delta(T(D))\) of the statistic T to changes in the data set D * Generate noise W = \(Laplace(\Delta(T(D))/ \epsilon)\) * Compute &amp; return the result \(T'(D) = T(D) + W\)</p>
<p>The statistic <em>T'</em> is now an \(\epsilon\)- differentially private version of <em>T</em>, as defined above.</p>
<h5 id="some-notes"><a class="header" href="#some-notes">Some notes:</a></h5>
<ul>
<li>
<p>For small values of \(\epsilon\) (i.e high degrees of privacy) significant levels of noise is added and so the values of <em>T'</em> will exhibit large variance for repeated queries and may provide unaccetably poor performance in most applications.</p>
</li>
<li>
<p>This approach only protects against information being divulged from the output of T by an adversiarl party, the data still needs to be stored safely by a trusted holder. This is the problem adressed by local DP, discussed below.</p>
</li>
</ul>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-r">#  Generate a data set
n = 200
heights = rnorm(n, 180, 5)

# Compute Sensitivity: 
#-------------------------------------------------------
f = rep(0, n)
for(i in 2:n-1){
    a = 1:(i-1)
    b = (i+1):n
    heights2 = c(heights[a], heights[b]) 
    f[i] = abs(mean(heights) - mean(heights2)) 
}

sensitivity = max(f)
print(max(f))
#-------------------------------------------------------

# Add noise: 
#-------------------------------------------------------
install.packages(&quot;rmutil&quot;)
install.packages(&quot;ggplot2&quot;)
require(rmutil)
require(ggplot2)

epsilon1 = 1
epsilon2 = 0.25
mse1 = rep(0,n)
mse2 = rep(0,n)

for(i in 1:n){
  dat = heights[1:i]
  out1 = mean(dat) + rlaplace(1, 0, sensitivity/epsilon1)
  out2 = mean(dat) + rlaplace(1, 0, sensitivity/epsilon2)
  mse1[i] = (180 - out1)^2
  mse2[i] = (180 - out2)^2
}

# Plot the results
x = 1:n
df = data.frame(x, mse1, mse2)

p = ggplot(df, aes(x)) +                    # basic graphical object
  geom_line(aes(y=mse1), colour= &quot;blue&quot;) +  # first layer
  geom_line(aes(y=mse2), colour= &quot;orange&quot;) # second layer
p + labs(title = &quot;Effect of Laplace Noise on MSE(Sample Size)&quot;) + xlab(&quot;Sample Size&quot;) + ylab(&quot;MSE&quot;)


#-------------------------------------------------------
</code></pre>
</div>
<div class="cell markdown">
<img src="http://i.imgur.com/eMoJkND.png" alt="drawing" width="500"/>
<h4 id="read-more-in-the-paper"><a class="header" href="#read-more-in-the-paper">Read More in the paper:</a></h4>
<p><a href="https://arxiv.org/abs/1607.00133">Additive Noise Models in Deep Learning</a></p>
</div>
<div class="cell markdown">
<p>This approach, as suggested by Duchi, Jordan, et. al, is based on privatizing the data before any statistics are computed, effectively meaning that the data is hidden even from the data scientist. Their suggestion is to apply a differentially private mechanism to the data and provide such mechanisms for some canonical problems.</p>
<h4 id="add-more-details"><a class="header" href="#add-more-details">Add more details</a></h4>
</div>
<div class="cell markdown">
<h4 id="experiment-setup"><a class="header" href="#experiment-setup">Experiment setup:</a></h4>
<p>As an example application, <a href="https://arxiv.org/abs/1604.02390">Duchi et. al</a> considers the problem of estimating means of drug use related hospitalizations. In the original problem, they have records of hospitalization of the form (drugs, year, # of hospitalizations) where the number of hospitalizations denotes how many people that year where admitted and used a certain drug. Many of the admitted individuals used several drugs, as the number of drugs were vastly larger than the number of admittances. We will use this information to generate a data set of measurements of the form \(X_i \in {0,1}^d\) representing one admission; a component <em>j</em> is 1 if the patient used drug <em>j</em> and 0 else. The usage frequency will be uniformly distributed over the samples generated, with only the constraint that the total number of admittances using drug <em>j</em> matches a preset number. This means that if there were <em>n</em> patients and <em>k</em> of them used drug <em>j</em> then \(X_ij = 1\) with probability <em>k/n</em>.</p>
<h4 id="methods"><a class="header" href="#methods">Methods:</a></h4>
<p>We have N = 1000 measurements of \(X_i \in {0,1}^d\) for <em>d = 27</em>, with a preset vector of admittance frequency. The problem is to estimate the mean of this population, \(\theta = E(X)\) and we will use three different approaches: * Non-private estimation * Min/Max optimal local privacy mechanism * Local Laplace Noise</p>
<p>Non-private estimation is simply the sample mean of the raw data, which is the &quot;gold standard&quot; of estimates that private methods are necesserally worse than. The min/max locally private mechanism consists of generating a new sample from the raw data which is sequentially dependent, in such a way that the new sample is differntially private and min/max optimal w.r.t to an arbitray loss function. This can be compared by the theoretical lower bound obtained in the paper. Lastly, one can compare this to a &quot;naive&quot; local privacy mechanism of adding <em>laplace(epsilon/d)</em> distributed noise to the data before estimation. Each method is analyzed through the l-infinity norm of the deviation from the full sample mean, as a function of the sample size.</p>
</div>
<div class="cell markdown">
<img src="http://i.imgur.com/oimTT7o.png" alt="drawing" width="750"/>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-r">#l-infinity sampling based privacy mechanism, as suggested by
l_inf_samp = function(X, alpha){

  n = length(X[,1])
  d = length(X[1,])
  samples = matrix(c(rep(0, n*d)), ncol = d, nrow = n)
  sample = rep(0,d)
  for(j in 1:n){
    x = X[j,]
    r = max(abs(x)) 
    x_hat = rep(0,d)

    for(i in 1:d){
      p = 0.5 + x[i]/(2*(r+(r==0)))
      y = rbinom(1, 1, p)
      x_hat[i] = (y==1)*r - (y==0)*r
    }
    
    A = 2^(d-1)
    
    if(d%%2 == 1){
      C = (1/A)*choose(d-1, 0.5*(d-1))
    } else{
      C = 1/(A+0.5*choose(d, 0.5*d))*choose(d-1, 0.5*d)
    }
    
    B = r*((exp(alpha)+1)/(exp(alpha)-1))*(1/C)
    
    pi_alph = exp(alpha)/(exp(alpha) + 1)
    T_alph = rbinom(1, 1, pi_alph)
    accept = FALSE
    
    while(!accept){
      z = runif(d, -B, B)
      dot = sum(z*x_hat)
      if((dot &gt;= 0)&amp;&amp;(T_alph == 1)){
        sample = z
        accept = TRUE
      }
      else if((dot &lt;= 0)&amp;&amp;(T_alph == 0)){
        sample = z 
        accept = TRUE
      }
    }
    samples[j,] = sample
  }
  return(samples)
}


my_mean = function(X){
  v_sum = rep(0,d)
  N = length(X[,1])
  for(i in 1:N){
    v_sum = v_sum + X[i,]  
  }
  return(v_sum/N)
}


gen_data = function(N,d,prop){
  X = matrix(c(rep(0,d*N)), ncol=d, nrow=N)
  for(i in 1:d){
    count = 0
    while(count &lt; prop[i]){
      idx = floor(runif(1,1,N))
      if(X[idx,i] == 0){
        X[idx,i] = 1
        count = count + 1
      }
    }
  }
  return(X)
}

</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-r">library(rmutil)
library(ggplot2)

# Set Parameters 
d = 27
alpha = 0.5

N_max = 1000
N_low = 100

# Initialize storage
error1 = rep(0, N_max-N_low)
error2 = rep(0, N_max-N_low)
error3 = rep(0, N_max-N_low)
low_bound = rep(0, N_max-N_low)

# Generate Data 
proportions = c(6, 2, 4, 2, 1, 1, 2, 6, 5, 4, 1, 9, 2, 6, 2, 1, 6, 2, 8, 5, 2, 8, 7, 5, 6, 4, 2)*N_max/15
X = gen_data(N_max, d, proportions)
theta_true = my_mean(X)

for(i in N_low:N_max){
  N = i
  
  X_n = X[1:i,]
  Z = l_inf_samp(X_n, alpha)
  
  W = matrix(rlaplace(N*d, 0, d/alpha), ncol = d, nrow = N)
  
  theta1 = my_mean(X_n)
  theta2 = my_mean(Z)
  theta3 = my_mean(X_n + W)
  
  error1[i-N_low+1] = max(abs(theta_true - theta1))
  error2[i-N_low+1] = max(abs(theta_true - theta2)) 
  error3[i-N_low+1] = max(abs(theta_true - theta3)) 

  a = d*log(2*d)
  b = (exp(alpha)-1)^2
  low_bound[i-N_low+1]  = sqrt(a/(N*b))
}

# Plot the results
x = N_low:(N_max)
df = data.frame(x, error2, error3)

p = ggplot(df, aes(x)) +                    # basic graphical object
  geom_line(aes(y=error1), colour= &quot;red&quot;) +  # Non-private estimate
  geom_line(aes(y=error2), colour= &quot;blue&quot;) + # Locally Private estimate
  geom_line(aes(y=error3), colour= &quot;orange&quot;) + # Laplace Mechanism
  geom_line(aes(y=low_bound), colour= &quot;black&quot;)  # Min/Max optimal bound

p +  ggtitle(&quot;L-inf Error of different estimation methods as a function of sample size&quot;) +
  xlab(&quot;Sample Size&quot;) + ylab(&quot;l-inf Error&quot;) + labs()
</code></pre>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>
        
        

    </body>
</html>
