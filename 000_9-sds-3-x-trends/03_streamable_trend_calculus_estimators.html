
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Markov Model for Trend Calculus &#8212; Scalable Data Science &amp; Distributed Machine Learning</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Plugging into GDELT Mass Media Streams" href="030_Spark_GDELT_project_001.html" />
    <link rel="prev" title="Streaming Trend Calculus with Maximum Necessary Reversals" href="02_streamable_trend_calculus.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Scalable Data Science & Distributed Machine Learning</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/000_ScaDaMaLe.html">
   Introduction
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Introduction to Apache Spark Core
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_1-sds-3-x/001_whySpark.html">
   Why Apache Spark?
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/002_00_loginToDatabricks.html">
     Login to databricks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/002_00_loginToDatabricks.html#import-course-content-now">
     Import Course Content Now!
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/002_00_loginToDatabricks.html#cloud-free-computing-environment">
     Cloud-free Computing Environment
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/002_01_multiLingualNotebooks.html">
     Multi-lingual Notebooks
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_1-sds-3-x/003_00_scalaCrashCourse.html">
   Scala Crash Course
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/003_01_scalaCrashCourse.html">
     Scala Crash Course Continued
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_1-sds-3-x/004_RDDsTransformationsActions.html">
   Introduction to Spark
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/005_RDDsTransformationsActionsHOMEWORK.html">
     HOMEWORK on RDD Transformations and Actions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/006a_PipedRDD.html">
     Piped RDDs and Bayesian AB Testing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/006a_PipedRDD.html#pipe-rdds-to-system-commands">
     Pipe RDDs to System Commands
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/006a_PipedRDD.html#mappartitions">
     mapPartitions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/006a_PipedRDD.html#foreachpartition">
     foreachPartition
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/006a_PipedRDD.html#numerically-rigorous-bayesian-ab-testing">
     Numerically Rigorous Bayesian AB Testing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/006a_PipedRDD.html#usage-instructions-for-isit1or2coins">
     Usage instructions for IsIt1or2Coins
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/006_WordCount.html">
     Word Count on US State of the Union (SoU) Addresses
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Introduction to Apache Spark SQL
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/007_SparkSQLIntroBasics.html">
   Introduction to Spark SQL
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_1-sds-3-x/007_SparkSQLIntroBasics.html#getting-started-in-spark-2-x">
   Getting Started in Spark 2.x
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007a_SparkSQLProgGuide_HW.html">
     Spark Sql Programming Guide
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007b_SparkSQLProgGuide_HW.html">
     Getting Started
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007b_SparkSQLProgGuide_HW.html#id1">
     Getting Started
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007c_SparkSQLProgGuide_HW.html">
     Getting Started - Exercise
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007d_SparkSQLProgGuide_HW.html">
     Data Sources
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007d_SparkSQLProgGuide_HW.html#id1">
     Data Sources
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007e_SparkSQLProgGuide_HW.html">
     Performance Tuning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007f_SparkSQLProgGuide_HW.html">
     Distributed SQL Engine
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007f_SparkSQLProgGuide_HW.html#id1">
     Distributed SQL Engine
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007g_PivotInSQL.html">
     SQL Pivoting since Spark 2.4
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007g_PivotInSQL.html#load-data">
     Load Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007g_PivotInSQL.html#pivoting-in-sql">
     Pivoting in SQL
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007g_PivotInSQL.html#pivoting-with-multiple-aggregate-expressions">
     Pivoting with Multiple Aggregate Expressions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007g_PivotInSQL.html#pivoting-with-multiple-grouping-columns">
     Pivoting with Multiple Grouping Columns
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/007g_PivotInSQL.html#pivoting-with-multiple-pivot-columns">
     Pivoting with Multiple Pivot Columns
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Extract Transform and Load
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/008_DiamondsPipeline_01ETLEDA.html">
   Diamonds ML Pipeline Workflow - DataFrame ETL and EDA Part
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/008_DiamondsPipeline_01ETLEDA.html#step-1-load-data-as-dataframe">
   Step 1. Load data as DataFrame
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/008_DiamondsPipeline_01ETLEDA.html#step-2-understand-the-data">
   Step 2. Understand the data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/008_DiamondsPipeline_01ETLEDA.html#let-us-run-through-some-basic-inteactive-sql-queries-next">
   Let us run through some basic inteactive SQL queries next
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/008_DiamondsPipeline_01ETLEDA.html#why-do-we-need-to-know-these-interactive-sql-queries">
   Why do we need to know these interactive SQL queries?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/008_DiamondsPipeline_01ETLEDA.html#we-will-continue-later-with-ml-pipelines-to-do-prediction-with-a-fitted-model-from-this-dataset">
   We will continue later with ML pipelines to do prediction with a fitted model from this dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/009_PowerPlantPipeline_01ETLEDA.html">
   Power Plant ML Pipeline Application - DataFrame Part
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/009_PowerPlantPipeline_01ETLEDA.html#step-1-business-understanding">
   Step 1: Business Understanding
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/009_PowerPlantPipeline_01ETLEDA.html#step-2-load-your-data">
   Step 2: Load Your Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/009_PowerPlantPipeline_01ETLEDA.html#use-this-for-other-smallish-datasets-you-want-to-import-to-your-ce">
   USE THIS FOR OTHER SMALLish DataSets you want to import to your CE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/009_PowerPlantPipeline_01ETLEDA.html#step-3-explore-your-data">
   Step 3: Explore Your Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/009_PowerPlantPipeline_01ETLEDA.html#step-4-visualize-your-data">
   Step 4: Visualize Your Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/010_wikipediaClickStream_01ETLEDA.html">
   Wiki Clickstream Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/010_wikipediaClickStream_01ETLEDA.html#wikipedia-logo">
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/033_OBO_LoadExtract.html">
   Old Bailey Online Data Analysis in Apache Spark
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_1-sds-3-x/033_OBO_LoadExtract.html#analysing-the-full-old-bailey-online-sessions-papers-dataset">
   Analysing the Full Old Bailey Online Sessions Papers Dataset
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html">
     Piped RDDs and Bayesian AB Testing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html#from-a-local-collection">
     From a Local Collection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html#glom">
     glom
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html#checkpointing">
     Checkpointing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html#pipe-rdds-to-system-commands">
     Pipe RDDs to System Commands
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html#mappartitions">
     mapPartitions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html#foreachpartition">
     foreachPartition
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html#numerically-rigorous-bayesian-ab-testing">
     Numerically Rigorous Bayesian AB Testing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html#usage-instructions-for-isit1or2coins">
     Usage instructions for IsIt1or2Coins
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html#parsing-the-output-from-isit1or2coins">
     Parsing the output from
     <code class="docutils literal notranslate">
      <span class="pre">
       IsIt1or2Coins
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_1-sds-3-x/033_OBO_PipedRDD_RigorousBayesianABTesting.html#providing-case-classes-for-input-and-output-for-easy-spark-communication">
     Providing case classes for input and output for easy spark communication
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_1-sds-3-x/035_LDA_CornellMovieDialogs.html">
   Topic Modeling of Movie Dialogs with Latent Dirichlet Allocation
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Trends in Money and News
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="000_TrendsInFinancialStocksAndNewsEvents.html">
   Trends in Financial Stocks and News Events
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="00a_FX1M.html">
     Historical FX-1-M Financial Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="00b_yfinance.html">
     yfinance Stock Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="000a_finance_utils.html">
     Utilities Needed for Financial Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="000b_gdelt_utils.html">
     Utilities Needed for Mass Media Data
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 current active collapsible-parent">
  <a class="reference internal" href="01_trend_calculus_showcase.html">
   Finding trends in oil price data.
  </a>
  <ul class="current collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="02_streamable_trend_calculus.html">
     Streaming Trend Calculus with Maximum Necessary Reversals
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Markov Model for Trend Calculus
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="030_Spark_GDELT_project_001.html">
   Plugging into GDELT Mass Media Streams
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="030a_gdelt_EOI_detection.html">
     Detecting Events of Interest to OIL/GAS Price Trends
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="030b_gdelt_POI_detection.html">
     Detecting Persons of Interest to OIL/GAS Price Trends
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Distributed Deep Learning with Horovod
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_7-sds-3-x-ddl/00_DDL_Introduction.html">
   Introduction to Distributed Deep Learning (DDL) with Horovod over Tensorflow/keras and Pytorch
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_7-sds-3-x-ddl/0x_mnist-tensorflow-keras.html">
     Distributed deep learning training using TensorFlow and Keras with HorovodRunner
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_7-sds-3-x-ddl/0y_mnist-pytorch.html">
     Distributed deep learning training using PyTorch with HorovodRunner for MNIST
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  WASP AI-Track Student Projects
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-01_group-TheTwoCultures/00_download_data.html">
   The two cultures
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-01_group-TheTwoCultures/01_load_data.html">
     Preprocessing and loading the relevant data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-01_group-TheTwoCultures/02_logisticregression.html">
     The two cultures - Classifying threads with logistic regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-01_group-TheTwoCultures/03_word2vec.html">
     Classification using Word2Vec
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-01_group-TheTwoCultures/04_LDA.html">
     Topic Modeling with LDA
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-02_group-LiUUmeaSceneGraphMotifs/01_SceneGraphMotifs.html">
   Exploring the GQA Scene Graph Dataset Structure and Properties
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-03_group-GuangyiZhang/01_triads.html">
   Signed Triads in Social Media
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-04_group-DistributedLinearAlgebra/01_DistributedSVD.html">
   Distributed Linear Algebra
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-04_group-DistributedLinearAlgebra/02_CollaborativeFiltering.html">
     Music Recommendation System
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-05_group-LundDirichletAnalysts/01_Wikipedia_LDA_Analysis.html">
   Wikipedia analysis using Latent Dirichlet Allocation (LDA)
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-06_group-ParticleClustering/00_Introduction.html">
   Unsupervised clustering of particle physics data with distributed training
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-06_group-ParticleClustering/01_data_and_preprocessing.html">
     Data and preprocessing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-06_group-ParticleClustering/02_dl_single_machine.html">
     UCluster on a single machine
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-06_group-ParticleClustering/03_dl_horovod.html">
     UCluster with distributed learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-06_group-ParticleClustering/04_evaluate.html">
     Evaluation
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-07_group-MathAtKTH/01_Coding_Motifs.html">
   Motif Finding
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-07_group-MathAtKTH/01_Coding_Motifs.html#application">
   Application
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-07_group-MathAtKTH/02_Data_Processing.html">
     Data Processing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-07_group-MathAtKTH/03_graph_string_converter.html">
     Intro
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-07_group-MathAtKTH/03_graph_string_converter.html#examples">
     Examples
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-08_group-DistributedEnsemble/00_project.html">
   Distributed ensembles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-08_group-DistributedEnsemble/00_project.html#distributed-ensembles-prediction-api">
   Distributed ensembles prediction API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-08_group-DistributedEnsemble/00_project.html#application-example-distributed-predictions">
   Application example: Distributed predictions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-08_group-DistributedEnsemble/00_project.html#application-example-out-of-distribution-detection">
   Application example: Out of distribution detection
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-09_group-TopicModeling/01_Introduction.html">
   Topic Modeling with SARS-Cov-2 Genome 🧬
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-09_group-TopicModeling/02_Data_Processing.html">
     Data Processing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-09_group-TopicModeling/03_LDA.html">
     LDA - Extract Features
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-09_group-TopicModeling/04_Classification_CountVector.html">
     Classification CountVector
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-09_group-TopicModeling/05_Classification.html">
     Load processed data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-09_group-TopicModeling/05_Classification.html#explore-data">
     Explore data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-09_group-TopicModeling/05_Classification.html#classification">
     Classification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-09_group-TopicModeling/05_Classification.html#evaluation">
     Evaluation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-09_group-TopicModeling/06_Results.html">
     Results and Conclusion
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-10_group-Geosmus/01_Introduction.html">
   Twitter Streaming Using Geolocation and Emoji Based Sentiment Analysis
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-10_group-Geosmus/02_ClusteringEmoticonsBasedOnTweets.html">
     Clustering emoticons based on tweets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-10_group-Geosmus/03_Dynamic_Tweet_Maps.html">
     Dynamic Tweet Maps
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-10_group-Geosmus/04_conclusion.html">
     Conclusion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-10_group-Geosmus/05_appendix_get-cc-data.html">
     Notebook for collecting tweets with country codes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-10_group-Geosmus/07_a_appendix_extendedTwitterUtils2run.html">
     ScaDaMaLe, Scalable Data Science and Distributed Machine Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-10_group-Geosmus/07_a_appendix_extendedTwitterUtils2run.html#extended-spark-streaming-twitter-twitterutils">
     Extended spark.streaming.twitter.TwitterUtils
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-10_group-Geosmus/07_b_appendix_TTTDFfunctions.html">
     ScaDaMaLe, Scalable Data Science and Distributed Machine Learning
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-11_group-Sketchings/00_QuantileEstimation.html">
   Anomaly Detection with Iterative Quantile Estimation and T-digest
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/00_ProjectDescriptionAndPlanning.html">
   Project Description and Introduction
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/01_DownloadFilesPeriodicallyScript.html">
     Download Files Periodically
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/01_StreamToFile.html">
     Stream to parquet file
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/021_DataPreprocess_Explain.html">
     Loading data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/021_DataPreprocess_Explain.html#preprocessing">
     Preprocessing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/02_DataPreprocess.html">
     Loading data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/02_DataPreprocess.html#preprocessing">
     Preprocessing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/03_ExplosiveAnalysis.html">
     This notebook is for explosive analysis of features in data.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/03_ExplosiveAnalysis.html#statistics-of-invariant-features">
     Statistics of invariant features
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/03_ExplosiveAnalysis.html#correlation-between-invariant-features">
     Correlation between invariant features
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/03_ExplosiveAnalysis.html#correlation-between-new-case-per-million-total-case-new-death-per-million-total-death-per-million-reproduction-rate-and-stringency-index">
     Correlation between new case per million, total case, new death per million, total death per million, reproduction rate and stringency index.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/04_DataVisualize.html">
     Show reproduction rate of selected countries i.e. Sweden, Germany, Danmark, Finland, Norway
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/04_DataVisualize.html#visualize-total-cases-total-deaths-new-cases-and-new-deaths-during-pandemic">
     Visualize total cases, total deaths, new cases and new deaths during pandemic
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/04_DataVisualize.html#total-deaths">
     Total Deaths
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/04_DataVisualize.html#new-cases">
     New Cases
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/04_DataVisualize.html#new-deaths">
     New Deaths
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/05_Clustering.html">
     Clustering of country features in the Covid 19 dataset
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/06_DataPredicton_LR.html">
     Prediction with Linear Regression (LR) Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/07_DataPredicton_ARIMA.html">
     Prediction with Time Series model - ARIMA
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-12_group-CovidPandemic/08_DataPrediction_GP.html">
     Prediction with time series model - Gaussian Processes
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-13_group-Genomics/01_1000genomes.html">
   Genomics Analysis with Glow and Spark
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-13_group-Genomics/01_1000genomes.html#load-libs-and-define-helper-functions">
   Load libs and define helper functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-13_group-Genomics/01_1000genomes.html#read-data">
   Read data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-13_group-Genomics/01_1000genomes.html#pca">
   PCA
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-13_group-Genomics/01_1000genomes.html#predicting-ethinicity">
   Predicting Ethinicity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-13_group-Genomics/01_1000genomes.html#filtering-of-snps-based-on-chi-squared-test">
   Filtering of SNPs based on chi-squared test
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-14_group-NullHypothesisEvaluationCriteria/00_distributed_combinatorial_bandit.html">
   Distributed combinatorial bandits
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-15_group-FinancialDataStreams/00_video.html">
   Reinforcement Learning for Intraday Trading
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-15_group-FinancialDataStreams/01_rl_intraday_trading.html">
     Reinforcement Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-15_group-FinancialDataStreams/01_rl_intraday_trading.html#summary-and-outlook">
     Summary and Outlook
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-15_group-FinancialDataStreams/02_rl_intraday_trading_elephas.html">
     Reinforcement Learning - Distributed model tuning with Elephas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-15_group-FinancialDataStreams/02_rl_intraday_trading_elephas.html#elephas">
     Elephas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-15_group-FinancialDataStreams/02_rl_intraday_trading_elephas.html#notes-to-the-elephas-training">
     Notes to the elephas training
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-15_group-FinancialDataStreams/03_resources.html">
     Resources
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-16_group-IntrusionDetection/00_Introduction.html">
   Intrusion Detection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-16_group-IntrusionDetection/00_Introduction.html#preparing-the-dataframe-for-training-classifers">
   Preparing the DataFrame for training classifers
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-17_group-TowardsScalableTDA/00_introduction.html">
   Density Estimation via Voronoi Diagrams in High Dimensions
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-17_group-TowardsScalableTDA/01_methodology.html">
     Methodology
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-17_group-TowardsScalableTDA/02_gaussian_analysis.html">
     Gaussian Analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-17_group-TowardsScalableTDA/03_robotics_dataset.html">
     Robotics Dataset
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-18_group-ProjectRL/00_Problem_Description.html">
   Recommender System
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-18_group-ProjectRL/01_The_ALS_method.html">
     <span class="xref myst">
      The Alternating Least Squares method (ALS)
     </span>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-18_group-ProjectRL/01_The_ALS_method.html#on-a-small-dataset">
     <span class="xref myst">
      On a small dataset
     </span>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-18_group-ProjectRL/01_The_ALS_method.html#on-a-large-dataset-netflix-dataset">
     <span class="xref myst">
      On a large dataset - Netflix dataset
     </span>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-18_group-ProjectRL/02_Extensions.html">
     Extensions
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-19_group-Featuring/01_FundamentalMatrix.html">
   Fundamental Matrix
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-20_group-Generalization/01_Background.html">
   MixUp and Generalization
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-20_group-Generalization/02_Random_Forest.html">
     Random Forests and MixUp
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-20_group-Generalization/03_CNN_MNIST.html">
     CNN for MNIST
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-20_group-Generalization/04_CNN_Intel_Image.html">
     CNN for Intel Image Classification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-20_group-Generalization/05_Horovod_test.html">
     CNNs and MixUp with Horovod
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-21_group-GraphSpectralAnalysis/00_introduction.html">
   Graph Spectral Analysis
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-21_group-GraphSpectralAnalysis/01_preprocess_data.html">
     Preprocess the data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-21_group-GraphSpectralAnalysis/02_generate_graphs.html">
     Generate random graphs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-21_group-GraphSpectralAnalysis/03_compute_rsvd.html">
     Compute RSVD
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-21_group-GraphSpectralAnalysis/04_analyse_eigenvalues.html">
     Analyse the eigenvalue spectrum
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-22_group-SwapWithDDP/00_Introduction.html">
   SWAP
   <em>
    With
   </em>
   DDP
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../000_0-sds-3-x-projects/student-project-22_group-SwapWithDDP/01_SWAP_with_DDP.html">
     SWAP
     <em>
      With
     </em>
     DDP
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/000_9-sds-3-x-trends/03_streamable_trend_calculus_estimators.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://lamastex.github.io/ScaDaMaLe/index.html"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://lamastex.github.io/ScaDaMaLe/index.html/issues/new?title=Issue%20on%20page%20%2F000_9-sds-3-x-trends/03_streamable_trend_calculus_estimators.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p>ScaDaMaLe Course
<a class="reference external" href="https://lamastex.github.io/scalable-data-science/sds/3/x/">site</a> and
<a class="reference external" href="https://lamastex.github.io/ScaDaMaLe/index.html">book</a></p>
<div class="section" id="markov-model-for-trend-calculus">
<h1>Markov Model for Trend Calculus<a class="headerlink" href="#markov-model-for-trend-calculus" title="Permalink to this headline">¶</a></h1>
<p>Johannes Graner
(<a class="reference external" href="https://www.linkedin.com/in/johannes-graner-475677129/">LinkedIn</a>),
Albert Nilsson
(<a class="reference external" href="https://www.linkedin.com/in/albert-nilsson-09b62b191/">LinkedIn</a>) and
Raazesh Sainudiin
(<a class="reference external" href="https://www.linkedin.com/in/raazesh-sainudiin-45955845/">LinkedIn</a>)</p>
<p>2020, Uppsala, Sweden</p>
<p>This project was supported by Combient Mix AB through summer internships
at:</p>
<p>Combient Competence Centre for Data Engineering Sciences, Department of
Mathematics, Uppsala University, Uppsala, Sweden</p>
<hr class="docutils" />
<p>We use the dataset generated in the last notebook to build a simple,
proof of concept Markov model for predicting trends.</p>
<p>This is merely to verify using a simple model if there is indeed any
predictive value in the trends and their reversals that many real-worl
traders bet on every instant in the market.</p>
<p><strong>Resources</strong></p>
<p>This builds on the following library and its antecedents therein:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/lamastex/spark-trend-calculus">https://github.com/lamastex/spark-trend-calculus</a></p></li>
</ul>
<p><strong>This work was inspired by:</strong></p>
<ul class="simple">
<li><p>Antoine Aamennd’s
<a class="reference external" href="https://github.com/aamend/texata-r2-2017">texata-2017</a></p></li>
<li><p>Andrew Morgan’s <a class="reference external" href="https://github.com/ByteSumoLtd/TrendCalculus-lua">Trend Calculus
Library</a></p></li>
</ul>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">run</span>
<span class="s">&quot;./000a_finance_utils&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">import</span> <span class="nn">java.sql.Timestamp</span>
<span class="k">import</span> <span class="nn">io.delta.tables._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.streaming.</span><span class="o">{</span><span class="nc">GroupState</span><span class="o">,</span> <span class="nc">GroupStateTimeout</span><span class="o">,</span> <span class="nc">OutputMode</span><span class="o">,</span> <span class="nc">Trigger</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.types._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.expressions.</span><span class="o">{</span><span class="nc">Window</span><span class="o">,</span> <span class="nc">WindowSpec</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.lamastex.spark.trendcalculus._</span>
<span class="k">import</span> <span class="nn">scala.util.Random</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>import java.sql.Timestamp
import io.delta.tables._
import org.apache.spark.sql._
import org.apache.spark.sql.functions._
import org.apache.spark.sql.streaming.{GroupState, GroupStateTimeout, OutputMode, Trigger}
import org.apache.spark.sql.types._
import org.apache.spark.sql.expressions.{Window, WindowSpec}
import org.lamastex.spark.trendcalculus._
import scala.util.Random
</pre></div>
</div>
</div>
</div>
<p>Reading the joined dataset from the last notebook.</p>
<p>We train the model using both oil and gold data and predict trends in
oil data. We show that this yields better results than just training on
the oil data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">rootPath</span> <span class="o">=</span> <span class="nc">TrendUtils</span><span class="o">.</span><span class="n">getStreamableTrendCalculusPath</span>
<span class="k">val</span> <span class="n">maxRevPath</span> <span class="o">=</span> <span class="n">rootPath</span> <span class="o">+</span> <span class="s">&quot;maxRev&quot;</span>
<span class="k">val</span> <span class="n">maxRevDS</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;delta&quot;</span><span class="o">).</span><span class="n">load</span><span class="o">(</span><span class="n">maxRevPath</span><span class="o">).</span><span class="n">as</span><span class="o">[</span><span class="kt">FlatReversal</span><span class="o">]</span>
</pre></div>
</div>
</div>
</div>
<p>We want to predict what the trend of the next data point will be given
the trend reversals we have observed.</p>
<p>For this, we use an m-th order Markov model. We look at the reversal
state of the last <code class="docutils literal notranslate"><span class="pre">m</span></code> points and use this to predict the trends in the
next <code class="docutils literal notranslate"><span class="pre">n</span></code> points. <code class="docutils literal notranslate"><span class="pre">k</span></code> is the maximum order of reversal that is considered
when training the model.</p>
<p><code class="docutils literal notranslate"><span class="pre">trainingRatio</span></code> is the ratio of the data used for training the model,
the rest is used for testing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">modelPath</span> <span class="o">=</span> <span class="n">rootPath</span> <span class="o">+</span> <span class="s">&quot;estimators/&quot;</span>
<span class="k">val</span> <span class="n">maxRevDSWithLagCountPath</span> <span class="o">=</span> <span class="n">modelPath</span> <span class="o">+</span> <span class="s">&quot;maxRevDSWithLag&quot;</span>

<span class="k">val</span> <span class="n">numPartitions</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">val</span> <span class="n">partialModelPaths</span> <span class="o">=</span> <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">numPartitions</span><span class="o">).</span><span class="n">map</span><span class="o">(</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="n">modelPath</span> <span class="o">+</span> <span class="s">s&quot;partialModel</span><span class="si">${</span><span class="n">i</span><span class="si">}</span><span class="s">&quot;</span> <span class="o">)</span>
<span class="k">val</span> <span class="n">fullModelPath</span> <span class="o">=</span> <span class="n">modelPath</span> <span class="o">+</span> <span class="s">&quot;fullModel&quot;</span>

<span class="k">val</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">val</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">val</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">18</span>
<span class="k">val</span> <span class="n">trainingRatio</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="k">type</span> <span class="kt">FinalModel</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span><span class="p">,</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span><span class="p">,</span> <span class="kt">Double</span><span class="o">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">def</span> <span class="n">truncRev</span><span class="o">(</span><span class="n">k</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="n">rev</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">math</span><span class="o">.</span><span class="n">abs</span><span class="o">(</span><span class="n">rev</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">k</span><span class="o">)</span> <span class="n">k</span><span class="o">*</span><span class="n">rev</span><span class="o">.</span><span class="n">signum</span> <span class="k">else</span> <span class="n">rev</span>
<span class="o">}</span>
<span class="k">val</span> <span class="n">truncRevUDF</span> <span class="o">=</span> <span class="n">udf</span><span class="o">{</span> <span class="n">rev</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=&gt;</span> <span class="n">rev</span><span class="o">.</span><span class="n">signum</span> <span class="o">}</span>
<span class="k">def</span> <span class="n">truncRevsUDF</span><span class="o">(</span><span class="n">k</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">=</span> <span class="n">udf</span><span class="o">{</span> <span class="n">revs</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="n">revs</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">truncRev</span><span class="o">(</span><span class="n">k</span><span class="o">))</span> <span class="o">}</span>

<span class="k">def</span> <span class="n">lagColumn</span><span class="o">(</span><span class="n">df</span><span class="k">:</span> <span class="kt">DataFrame</span><span class="o">,</span> <span class="n">orderColumnName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">lagKeyName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">lagValueName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">m</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">DataFrame</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">windowSpec</span> <span class="o">=</span> <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class="s">&quot;ticker&quot;</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class="n">orderColumnName</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">laggedKeyColNames</span> <span class="o">=</span> <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">m</span><span class="o">).</span><span class="n">map</span><span class="o">(</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="s">s&quot;lagKey</span><span class="si">$i</span><span class="s">&quot;</span> <span class="o">).</span><span class="n">toSeq</span>
  <span class="k">val</span> <span class="n">laggedValueColNames</span> <span class="o">=</span> <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">n</span><span class="o">).</span><span class="n">map</span><span class="o">(</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="s">s&quot;lagValue</span><span class="si">$i</span><span class="s">&quot;</span> <span class="o">).</span><span class="n">toSeq</span>
  <span class="k">val</span> <span class="n">dfWithLaggedKeyColumns</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="n">to</span> <span class="n">m</span><span class="o">+</span><span class="n">n</span><span class="o">)</span>
    <span class="o">.</span><span class="n">foldLeft</span><span class="o">(</span><span class="n">df</span><span class="o">)(</span> <span class="o">(</span><span class="n">df</span><span class="k">:</span> <span class="kt">DataFrame</span><span class="o">,</span> <span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="n">laggedKeyColNames</span><span class="o">(</span><span class="n">i</span><span class="o">-</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">),</span> <span class="n">lag</span><span class="o">(</span><span class="n">lagKeyName</span><span class="o">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MaxValue</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">windowSpec</span><span class="o">))</span> <span class="o">)</span>
  <span class="k">val</span> <span class="n">dfWithLaggedKeyValueColumns</span> <span class="o">=</span> <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">n</span><span class="o">)</span>
    <span class="o">.</span><span class="n">foldLeft</span><span class="o">(</span><span class="n">dfWithLaggedKeyColumns</span><span class="o">)(</span> <span class="o">(</span><span class="n">df</span><span class="k">:</span> <span class="kt">DataFrame</span><span class="o">,</span> <span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="n">laggedValueColNames</span><span class="o">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">),</span> <span class="n">lag</span><span class="o">(</span><span class="n">lagValueName</span><span class="o">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MaxValue</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">windowSpec</span><span class="o">))</span> <span class="o">)</span>
  
  <span class="n">dfWithLaggedKeyValueColumns</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;lagKey&quot;</span><span class="o">,</span> <span class="n">array</span><span class="o">(</span><span class="n">laggedKeyColNames</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="n">m</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="k">_</span><span class="o">))</span><span class="k">:_</span><span class="kt">*</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;lagValue&quot;</span><span class="o">,</span> <span class="n">array</span><span class="o">(</span><span class="n">laggedValueColNames</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">takeRight</span><span class="o">(</span><span class="n">n</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="k">_</span><span class="o">))</span><span class="k">:_</span><span class="kt">*</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;lagKeyFirst&quot;</span><span class="o">,</span> <span class="n">col</span><span class="o">(</span><span class="n">laggedKeyColNames</span><span class="o">.</span><span class="n">last</span><span class="o">))</span>
    <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;lagKeyFirst&quot;</span> <span class="o">=!=</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MaxValue</span><span class="o">)</span>
    <span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="s">&quot;lagKeyFirst&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="n">laggedKeyColNames</span><span class="k">:_</span><span class="kt">*</span><span class="o">)</span>
    <span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="n">laggedValueColNames</span><span class="k">:_</span><span class="kt">*</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>truncRev: (k: Int)(rev: Int)Int
truncRevUDF: org.apache.spark.sql.expressions.UserDefinedFunction = UserDefinedFunction(&lt;function1&gt;,IntegerType,Some(List(IntegerType)))
truncRevsUDF: (k: Int)org.apache.spark.sql.expressions.UserDefinedFunction
lagColumn: (df: org.apache.spark.sql.DataFrame, orderColumnName: String, lagKeyName: String, lagValueName: String, m: Int, n: Int)org.apache.spark.sql.DataFrame
</pre></div>
</div>
</div>
</div>
<p>The trend at each point can be extracted from the trend reversals by
taking the sum of all previous 1-st order trend reversals. This sum will
always be either 0 (up trend) or -1 (down trend) and 0 is therefore
mapped to 1 to get (1, -1) as (up, down).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">maxRevDSWithLag</span> <span class="o">=</span> <span class="n">lagColumn</span><span class="o">(</span>
  <span class="n">maxRevDS</span>
    <span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;x&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">toDF</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;truncRev&quot;</span><span class="o">,</span> <span class="n">truncRevUDF</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;reversal&quot;</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span>
      <span class="s">&quot;tmpTrend&quot;</span><span class="o">,</span>
      <span class="n">sum</span><span class="o">(</span><span class="s">&quot;truncRev&quot;</span><span class="o">).</span><span class="n">over</span><span class="o">(</span>
        <span class="nc">Window</span>
          <span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class="s">&quot;ticker&quot;</span><span class="o">)</span>
          <span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;x&quot;</span><span class="o">)</span>
          <span class="o">.</span><span class="n">rowsBetween</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="n">unboundedPreceding</span><span class="o">,</span> <span class="nc">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="o">)</span>
      <span class="o">)</span>
    <span class="o">)</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;trend&quot;</span><span class="o">,</span> <span class="n">when</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;tmpTrend&quot;</span> <span class="o">===</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="n">otherwise</span><span class="o">(-</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="s">&quot;truncRev&quot;</span><span class="o">,</span> <span class="s">&quot;tmpTrend&quot;</span><span class="o">),</span>
  <span class="s">&quot;x&quot;</span><span class="o">,</span> 
  <span class="s">&quot;reversal&quot;</span><span class="o">,</span>
  <span class="s">&quot;trend&quot;</span><span class="o">,</span>
  <span class="n">m</span><span class="o">,</span> 
  <span class="n">n</span>
<span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>maxRevDSWithLag: org.apache.spark.sql.DataFrame = [ticker: string, x: timestamp ... 5 more fields]
</pre></div>
</div>
</div>
</div>
<p>We now want to predict <code class="docutils literal notranslate"><span class="pre">lagValue</span></code> from <code class="docutils literal notranslate"><span class="pre">lagKey</span></code>.</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="n">display</span><span class="o">(</span><span class="n">maxRevDSWithLag</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<p>Cleaning up last run and writing model training input to delta tables.</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">rm</span><span class="o">(</span><span class="n">maxRevDSWithLagCountPath</span><span class="o">,</span> <span class="n">recurse</span><span class="k">=</span><span class="kc">true</span><span class="o">)</span>

<span class="n">maxRevDSWithLag</span>
  <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">,</span> <span class="n">lit</span><span class="o">(</span><span class="mi">1L</span><span class="o">))</span>
  <span class="o">.</span><span class="n">write</span>
  <span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;delta&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">mode</span><span class="o">(</span><span class="s">&quot;overwrite&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">save</span><span class="o">(</span><span class="n">maxRevDSWithLagCountPath</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">divUDF</span> <span class="o">=</span> <span class="n">udf</span><span class="o">{</span> <span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">toDouble</span><span class="o">/</span><span class="n">b</span> <span class="o">}</span>
<span class="k">val</span> <span class="n">maxRevDSWithLagCount</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;delta&quot;</span><span class="o">).</span><span class="n">load</span><span class="o">(</span><span class="n">maxRevDSWithLagCountPath</span><span class="o">)</span>
<span class="k">val</span> <span class="n">numberOfRows</span> <span class="o">=</span> <span class="n">maxRevDSWithLagCount</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>divUDF: org.apache.spark.sql.expressions.UserDefinedFunction = UserDefinedFunction(&lt;function2&gt;,DoubleType,Some(List(LongType, LongType)))
maxRevDSWithLagCount: org.apache.spark.sql.DataFrame = [ticker: string, x: timestamp ... 6 more fields]
numberOfRows: Long = 6845798
</pre></div>
</div>
</div>
</div>
<p>The data is split into training and testing data. This is <em>not</em> done
randomly as there is a dependence on previous data points. We don’t want
to train on data that is dependent on the testing data and therefore the
training data consists of the first (for example) 70% of the data and
the last 30% is saved for testing. This also reflects how the model
would be used since we can only train on data points that have already
been observed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">tickers</span> <span class="o">=</span> <span class="n">maxRevDSWithLagCount</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;ticker&quot;</span><span class="o">).</span><span class="n">distinct</span><span class="o">.</span><span class="n">as</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">collect</span><span class="o">.</span><span class="n">toSeq</span>
<span class="k">val</span> <span class="n">tickerDFs</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">ticker</span> <span class="o">=&gt;</span> <span class="n">maxRevDSWithLagCount</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;ticker&quot;</span> <span class="o">===</span> <span class="n">ticker</span><span class="o">))</span>
<span class="k">val</span> <span class="n">trainingDF</span> <span class="o">=</span> <span class="n">tickerDFs</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">df</span> <span class="o">=&gt;</span> <span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="o">((</span><span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="o">*</span><span class="n">trainingRatio</span><span class="o">).</span><span class="n">toInt</span><span class="o">)</span> <span class="o">).</span><span class="n">reduce</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">union</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;x&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">trainingRows</span> <span class="o">=</span> <span class="n">trainingDF</span><span class="o">.</span><span class="n">count</span>

<span class="k">val</span> <span class="n">testingDF</span> <span class="o">=</span> <span class="n">maxRevDSWithLagCount</span><span class="o">.</span><span class="n">except</span><span class="o">(</span><span class="n">trainingDF</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tickers: Seq[String] = WrappedArray(XAUUSD, BCOUSD)
tickerDFs: Seq[org.apache.spark.sql.Dataset[org.apache.spark.sql.Row]] = ArrayBuffer([ticker: string, x: timestamp ... 6 more fields], [ticker: string, x: timestamp ... 6 more fields])
trainingDF: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [ticker: string, x: timestamp ... 6 more fields]
trainingRows: Long = 4792058
testingDF: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [ticker: string, x: timestamp ... 6 more fields]
</pre></div>
</div>
</div>
</div>
<p>Create <code class="docutils literal notranslate"><span class="pre">numTrainingSets</span></code> training set of increasing size to get
snapshots of how a partially trained model looks like. The sizes are
spaced logarithmically since the improvement in the model is fastest in
the beginning.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">rowsInPartitions</span> <span class="o">=</span> <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">numPartitions</span><span class="o">).</span><span class="n">map</span><span class="o">{</span> <span class="n">i</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="o">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="o">(</span><span class="n">trainingRows</span><span class="o">)*</span><span class="n">i</span><span class="o">/</span><span class="n">numPartitions</span><span class="o">)).</span><span class="n">toInt</span> <span class="o">}</span><span class="c1">//.scanLeft(0.0)(_-_)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>rowsInPartitions: scala.collection.immutable.IndexedSeq[Int] = Vector(4, 21, 100, 470, 2189, 10193, 47464, 221012, 1029129, 4792058)
</pre></div>
</div>
</div>
</div>
<p>Model is trained by counting how many times each (<code class="docutils literal notranslate"><span class="pre">lagKey</span></code>, <code class="docutils literal notranslate"><span class="pre">lagValue</span></code>)
pair is observed and dividing by how many times <code class="docutils literal notranslate"><span class="pre">lagKey</span></code> is observed to
get an estimation of the transition probabilities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">keyValueCountPartialDFs</span> <span class="o">=</span> <span class="n">rowsInPartitions</span><span class="o">.</span><span class="n">map</span><span class="o">(</span>
  <span class="n">trainingDF</span>
    <span class="o">.</span><span class="n">limit</span><span class="o">(</span><span class="k">_</span><span class="o">)</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;keyValueObs&quot;</span><span class="o">,</span> <span class="n">sum</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;lagKey&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;lagValue&quot;</span><span class="o">)))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;totalKeyObs&quot;</span><span class="o">,</span> <span class="n">sum</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;lagKey&quot;</span><span class="o">)))</span>
    <span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">)</span>
<span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>keyValueCountPartialDFs: scala.collection.immutable.IndexedSeq[org.apache.spark.sql.DataFrame] = Vector([ticker: string, x: timestamp ... 7 more fields], [ticker: string, x: timestamp ... 7 more fields], [ticker: string, x: timestamp ... 7 more fields], [ticker: string, x: timestamp ... 7 more fields], [ticker: string, x: timestamp ... 7 more fields], [ticker: string, x: timestamp ... 7 more fields], [ticker: string, x: timestamp ... 7 more fields], [ticker: string, x: timestamp ... 7 more fields], [ticker: string, x: timestamp ... 7 more fields], [ticker: string, x: timestamp ... 7 more fields])
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="n">display</span><span class="o">(</span><span class="n">keyValueCountPartialDFs</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;keyValueObs&quot;</span><span class="o">.</span><span class="n">desc</span><span class="o">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="n">keyValueCountPartialDFs</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">df</span> <span class="o">=&gt;</span>
    <span class="n">df</span>
      <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;probability&quot;</span><span class="o">,</span> <span class="n">divUDF</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;keyValueObs&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;totalKeyObs&quot;</span><span class="o">))</span>
      <span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="s">&quot;keyValueObs&quot;</span><span class="o">,</span> <span class="s">&quot;totalKeyObs&quot;</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="o">.</span><span class="n">zip</span><span class="o">(</span><span class="n">partialModelPaths</span><span class="o">).</span><span class="n">map</span><span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">df</span><span class="k">:</span> <span class="kt">DataFrame</span><span class="o">,</span> <span class="n">path</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">=&gt;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">mode</span><span class="o">(</span><span class="s">&quot;overwrite&quot;</span><span class="o">).</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;delta&quot;</span><span class="o">).</span><span class="n">save</span><span class="o">(</span><span class="n">path</span><span class="o">)</span>  
  <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>res9: scala.collection.immutable.IndexedSeq[Unit] = Vector((), (), (), (), (), (), (), (), (), ())
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">probDFs</span> <span class="o">=</span> <span class="n">partialModelPaths</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;delta&quot;</span><span class="o">).</span><span class="n">load</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>probDFs: scala.collection.immutable.IndexedSeq[org.apache.spark.sql.DataFrame] = Vector([ticker: string, x: timestamp ... 6 more fields], [ticker: string, x: timestamp ... 6 more fields], [ticker: string, x: timestamp ... 6 more fields], [ticker: string, x: timestamp ... 6 more fields], [ticker: string, x: timestamp ... 6 more fields], [ticker: string, x: timestamp ... 6 more fields], [ticker: string, x: timestamp ... 6 more fields], [ticker: string, x: timestamp ... 6 more fields], [ticker: string, x: timestamp ... 6 more fields], [ticker: string, x: timestamp ... 6 more fields])
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="n">display</span><span class="o">(</span><span class="n">probDFs</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;probability&quot;</span><span class="o">))</span>
</pre></div>
</div>
</div>
</div>
<p>The prediction is given by taking</p>
<div class="math notranslate nohighlight">
\[  V \in argmax(P_K(V)) 
\]</div>
<p>where *P_K(V)* is the probability that <em>V</em> is the next trend when the
last <code class="docutils literal notranslate"><span class="pre">m</span></code> points have had reversals <em>K</em>. If there are more than one
elements in argmax, an element is chosen uniformly at random.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">aggWindow</span> <span class="o">=</span> <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class="s">&quot;lagKey&quot;</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;probability</span> <span class="n">desc</span><span class="o">)</span>
<span class="k">val</span> <span class="n">testedDFs</span> <span class="o">=</span> <span class="n">probDFs</span>
  <span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">df</span> <span class="o">=&gt;</span>
     <span class="k">val</span> <span class="n">predictionDF</span> <span class="o">=</span> <span class="n">df</span>
      <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;lagKey&quot;</span><span class="o">,</span> <span class="s">&quot;lagValue&quot;</span><span class="o">,</span> <span class="s">&quot;probability&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">distinct</span>
      <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;rank&quot;</span><span class="o">,</span> <span class="n">rank</span><span class="o">().</span><span class="n">over</span><span class="o">(</span><span class="n">aggWindow</span><span class="o">))</span>
      <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="s">&quot;rank == 1&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="s">&quot;lagKey&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">agg</span><span class="o">(</span><span class="n">collect_list</span><span class="o">(</span><span class="s">&quot;lagValue&quot;</span><span class="o">))</span>
    
    <span class="n">testingDF</span>
      <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;ticker&quot;</span> <span class="o">===</span> <span class="s">&quot;BCOUSD&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">predictionDF</span><span class="o">,</span> <span class="nc">Seq</span><span class="o">(</span><span class="s">&quot;lagKey&quot;</span><span class="o">),</span> <span class="s">&quot;left&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">withColumnRenamed</span><span class="o">(</span><span class="s">&quot;collect_list(lagValue)&quot;</span><span class="o">,</span> <span class="s">&quot;test&quot;</span><span class="o">)</span>
  <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>warning: there was one feature warning; re-run with -feature for details
aggWindow: org.apache.spark.sql.expressions.WindowSpec = org.apache.spark.sql.expressions.WindowSpec@4f988e13
testedDFs: scala.collection.immutable.IndexedSeq[org.apache.spark.sql.DataFrame] = Vector([lagKey: array&lt;int&gt;, ticker: string ... 7 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 7 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 7 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 7 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 7 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 7 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 7 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 7 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 7 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 7 more fields])
</pre></div>
</div>
</div>
</div>
<p>We use a binary loss function that indicates if the prediction was
correct or not.</p>
<p><code class="docutils literal notranslate"><span class="pre">getRandomUDF</span></code> is used to choose an element at random in
argmax(P_K(V)). <code class="docutils literal notranslate"><span class="pre">safeArr</span></code> is used since we might see patterns in the
test data that were not present in the training data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">getRandomUDF</span> <span class="o">=</span> <span class="n">udf</span><span class="o">(</span> <span class="o">(</span><span class="n">arr</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">]])</span> <span class="o">=&gt;</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">safeArr</span> <span class="o">=</span> <span class="nc">Option</span><span class="o">(</span><span class="n">arr</span><span class="o">).</span><span class="n">getOrElse</span><span class="o">(</span><span class="nc">Seq</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]())</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">safeArr</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="nc">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">]()</span> <span class="k">else</span> <span class="n">safeArr</span><span class="o">(</span><span class="nc">Random</span><span class="o">.</span><span class="n">nextInt</span><span class="o">(</span><span class="n">safeArr</span><span class="o">.</span><span class="n">size</span><span class="o">))</span>
<span class="o">}</span> <span class="o">)</span>

<span class="k">val</span> <span class="n">lossUDF</span> <span class="o">=</span> <span class="n">udf</span><span class="o">{</span> <span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span> <span class="n">pred</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span> <span class="o">=&gt;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">pred</span><span class="o">)</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>getRandomUDF: org.apache.spark.sql.expressions.UserDefinedFunction = UserDefinedFunction(&lt;function1&gt;,ArrayType(IntegerType,false),Some(List(ArrayType(ArrayType(IntegerType,false),true))))
lossUDF: org.apache.spark.sql.expressions.UserDefinedFunction = UserDefinedFunction(&lt;function2&gt;,IntegerType,Some(List(ArrayType(IntegerType,false), ArrayType(IntegerType,false))))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">lossDFs</span> <span class="o">=</span> <span class="n">testedDFs</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;prediction&quot;</span><span class="o">,</span> <span class="n">getRandomUDF</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;test&quot;</span><span class="o">)).</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;loss&quot;</span><span class="o">,</span> <span class="n">lossUDF</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;lagValue&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;prediction&quot;</span><span class="o">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>lossDFs: scala.collection.immutable.IndexedSeq[org.apache.spark.sql.DataFrame] = Vector([lagKey: array&lt;int&gt;, ticker: string ... 9 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 9 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 9 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 9 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 9 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 9 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 9 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 9 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 9 more fields], [lagKey: array&lt;int&gt;, ticker: string ... 9 more fields])
</pre></div>
</div>
</div>
</div>
<p>Already on line 2 we see a case where <code class="docutils literal notranslate"><span class="pre">lagKey</span></code> was previously not
observed (indicated by <code class="docutils literal notranslate"><span class="pre">null</span></code> in test column).</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="n">display</span><span class="o">(</span><span class="n">lossDFs</span><span class="o">.</span><span class="n">last</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">testLength</span> <span class="o">=</span> <span class="n">testingDF</span><span class="o">.</span><span class="n">count</span>
<span class="k">val</span> <span class="n">oilTestDF</span> <span class="o">=</span> <span class="n">testingDF</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;ticker&quot;</span> <span class="o">===</span> <span class="s">&quot;BCOUSD&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">oilTestLength</span> <span class="o">=</span> <span class="n">oilTestDF</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>testLength: Long = 2053732
oilTestDF: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [ticker: string, x: timestamp ... 6 more fields]
oilTestLength: Long = 857750
</pre></div>
</div>
</div>
</div>
<p>Out of roughly 2 million observations, about 860k were oil price.</p>
<p>We find the mean loss for each training dataset of increasing size. As
one can see, the loss decreases as more data is supplied.</p>
<p>Further, training on both oil and gold data yields a better result than
just oil, suggesting that trends behave similarly in the two
commodities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">losses</span> <span class="o">=</span> <span class="n">lossDFs</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">agg</span><span class="o">(</span><span class="n">sum</span><span class="o">(</span><span class="s">&quot;loss&quot;</span><span class="o">)).</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;sum(loss)&quot;</span><span class="o">.</span><span class="n">as</span><span class="o">(</span><span class="s">&quot;totalLoss&quot;</span><span class="o">)).</span><span class="n">collect</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">toDouble</span><span class="o">/</span><span class="n">oilTestLength</span> <span class="o">)</span>
<span class="c1">// Data up to 2019</span>
<span class="c1">// k=max, m=2 ,n=1: (0.5489615950080244, 0.4014721726541194, 0.3660973816818738, 0.36497087640146797, 0.36485163238050344)</span>
<span class="c1">// k=max, m=10,n=1: (0.9812730246821787, 0.8523390131056561, 0.5819573469954631, 0.3552177121357085, 0.2807503135425113)</span>
<span class="c1">// k=max,m=100,n=1: (1.0, 1.0, 1.0, 1.0, 1.0)</span>
<span class="c1">// k=5  , m=10,n=1: (0.9812730246821787, 0.8522267831239777, 0.5820597568537447, 0.3550507700379618, 0.2806352778112909)</span>
<span class="c1">// k=1  , m=10,n=1: (0.9812730246821787, 0.852200128503329, 0.5821242890932098, 0.3553383593660128, 0.2806549180580846)</span>

<span class="c1">// k=max, m=10,n=2: (0.9879380657977248, 0.9049354606556204, 0.7243136776273427, 0.5472986906951395, 0.4783823708897465)</span>

<span class="c1">// k=max(17), m=10,n=1, 10 training sets: (0.9977203284971564, 0.9812730246821787, 0.9455375956409875, 0.8523810993487855, 0.7183644724769999, 0.5819320952495854, 0.44607349380350214, 0.35513915114853356, 0.3029480010437388, 0.280629666312207)</span>

<span class="c1">// Data up to last month</span>
<span class="c1">// k=max(18), m=10,n=1, 10 training sets: (0.9973104051296998, 0.9843882250072865, 0.9510789857184494, 0.8574351501020111, 0.7515744680851064, 0.6360547945205479, 0.5099656076945497, 0.4249921305741766, 0.3735668901194987, 0.34609501603031184)</span>
<span class="c1">// Could the difference be due to Corona?</span>

<span class="c1">// Trained on both oil and gold. testing on oil as previously.</span>
<span class="c1">// k=max(18), m=10,n=1, 10 training sets: (0.9999778490236083, 0.9980728650539201, 0.9527158262897114, 0.8921317400174876, 0.7559988341591373, 0.5820915185077237, 0.46675488195861264, 0.3923101136694841, 0.3574876129408336, 0.3355837948120082)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>losses: scala.collection.immutable.IndexedSeq[Double] = Vector(0.9999778490236083, 0.9980728650539201, 0.9527158262897114, 0.8921317400174876, 0.7559988341591373, 0.5820915185077237, 0.46675488195861264, 0.3923101136694841, 0.3574876129408336, 0.3355837948120082)
</pre></div>
</div>
</div>
</div>
<p>Visualizing the improvement of the model as the size of training data
increases.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">trainingSizes</span> <span class="o">=</span> <span class="n">probDFs</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">count</span><span class="o">)</span>
<span class="k">val</span> <span class="n">lossesDS</span> <span class="o">=</span> <span class="n">sc</span>
  <span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="n">losses</span><span class="o">.</span><span class="n">zip</span><span class="o">(</span><span class="n">trainingSizes</span><span class="o">))</span>
  <span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">&quot;loss&quot;</span><span class="o">,</span> <span class="s">&quot;size&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;training&quot;</span><span class="o">,</span> <span class="n">lit</span><span class="o">(</span><span class="s">&quot;Oil and Gold&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">union</span><span class="o">(</span>
    <span class="n">sc</span>
      <span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="nc">Seq</span><span class="o">(</span><span class="mf">0.9973104051296998</span><span class="o">,</span> <span class="mf">0.9843882250072865</span><span class="o">,</span> <span class="mf">0.9510789857184494</span><span class="o">,</span> <span class="mf">0.8574351501020111</span><span class="o">,</span> <span class="mf">0.7515744680851064</span><span class="o">,</span> <span class="mf">0.6360547945205479</span><span class="o">,</span> <span class="mf">0.5099656076945497</span><span class="o">,</span> <span class="mf">0.4249921305741766</span><span class="o">,</span> <span class="mf">0.3735668901194987</span><span class="o">,</span> <span class="mf">0.34609501603031184</span><span class="o">).</span><span class="n">zip</span><span class="o">(</span><span class="nc">Seq</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mi">18</span><span class="o">,</span> <span class="mi">77</span><span class="o">,</span> <span class="mi">331</span><span class="o">,</span> <span class="mi">1414</span><span class="o">,</span> <span class="mi">6036</span><span class="o">,</span> <span class="mi">25759</span><span class="o">,</span> <span class="mi">109918</span><span class="o">,</span> <span class="mi">469036</span><span class="o">,</span> <span class="mi">2001430</span><span class="o">)))</span>
      <span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">&quot;loss&quot;</span><span class="o">,</span> <span class="s">&quot;size&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;training&quot;</span><span class="o">,</span> <span class="n">lit</span><span class="o">(</span><span class="s">&quot;Oil&quot;</span><span class="o">))</span>
  <span class="o">)</span>
  <span class="o">.</span><span class="n">as</span><span class="o">[(</span><span class="kt">Double</span><span class="p">,</span><span class="kt">Long</span><span class="p">,</span><span class="kt">String</span><span class="o">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>trainingSizes: scala.collection.immutable.IndexedSeq[Long] = Vector(4, 21, 100, 470, 2189, 10193, 47464, 221012, 1029129, 4792058)
lossesDS: org.apache.spark.sql.Dataset[(Double, Long, String)] = [loss: double, size: bigint ... 1 more field]
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="n">display</span><span class="o">(</span><span class="n">lossesDS</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead>
<tr class="header">
<th>loss</th>
<th>size</th>
<th>training</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.9999778490236083</td>
<td>4.0</td>
<td>Oil and Gold</td>
</tr>
<tr class="even">
<td>0.9980728650539201</td>
<td>21.0</td>
<td>Oil and Gold</td>
</tr>
<tr class="odd">
<td>0.9527158262897114</td>
<td>100.0</td>
<td>Oil and Gold</td>
</tr>
<tr class="even">
<td>0.8921317400174876</td>
<td>470.0</td>
<td>Oil and Gold</td>
</tr>
<tr class="odd">
<td>0.7559988341591373</td>
<td>2189.0</td>
<td>Oil and Gold</td>
</tr>
<tr class="even">
<td>0.5820915185077237</td>
<td>10193.0</td>
<td>Oil and Gold</td>
</tr>
<tr class="odd">
<td>0.46675488195861264</td>
<td>47464.0</td>
<td>Oil and Gold</td>
</tr>
<tr class="even">
<td>0.3923101136694841</td>
<td>221012.0</td>
<td>Oil and Gold</td>
</tr>
<tr class="odd">
<td>0.3574876129408336</td>
<td>1029129.0</td>
<td>Oil and Gold</td>
</tr>
<tr class="even">
<td>0.3355837948120082</td>
<td>4792058.0</td>
<td>Oil and Gold</td>
</tr>
<tr class="odd">
<td>0.9973104051296998</td>
<td>4.0</td>
<td>Oil</td>
</tr>
<tr class="even">
<td>0.9843882250072865</td>
<td>18.0</td>
<td>Oil</td>
</tr>
<tr class="odd">
<td>0.9510789857184494</td>
<td>77.0</td>
<td>Oil</td>
</tr>
<tr class="even">
<td>0.8574351501020111</td>
<td>331.0</td>
<td>Oil</td>
</tr>
<tr class="odd">
<td>0.7515744680851064</td>
<td>1414.0</td>
<td>Oil</td>
</tr>
<tr class="even">
<td>0.6360547945205479</td>
<td>6036.0</td>
<td>Oil</td>
</tr>
<tr class="odd">
<td>0.5099656076945497</td>
<td>25759.0</td>
<td>Oil</td>
</tr>
<tr class="even">
<td>0.4249921305741766</td>
<td>109918.0</td>
<td>Oil</td>
</tr>
<tr class="odd">
<td>0.3735668901194987</td>
<td>469036.0</td>
<td>Oil</td>
</tr>
<tr class="even">
<td>0.34609501603031184</td>
<td>2001430.0</td>
<td>Oil</td>
</tr>
</tbody>
</table></div></div>
</div>
<p>The series using only oil data is very similar to the one with both oil
and gold data. The final data point has a loss of about 0.35, meaning
that the model accuracy is around 65% for predicting the the trend of
the next point in the time series.</p>
<p>To better understand the difference between the different (partially
trained) models, we want to calculate the total variation distance
between them.</p>
<p>The first step is to collect the models and work with them locally.</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">partialModels</span> <span class="o">=</span> <span class="n">probDFs</span><span class="o">.</span><span class="n">map</span><span class="o">{</span><span class="n">df</span> <span class="o">=&gt;</span> 
  <span class="k">val</span> <span class="n">tmpMap</span> <span class="o">=</span> <span class="n">df</span>
    <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;lagKey&quot;</span><span class="o">,</span> <span class="s">&quot;lagValue&quot;</span><span class="o">,</span> <span class="s">&quot;probability&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">distinct</span>
    <span class="o">.</span><span class="n">collect</span>
    <span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="n">r</span> <span class="o">=&gt;</span> 
      <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">]](</span><span class="mi">0</span><span class="o">),</span> <span class="n">r</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">]](</span><span class="mi">1</span><span class="o">),</span> <span class="n">r</span><span class="o">.</span><span class="n">getDouble</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>
    <span class="o">}</span>
    <span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_1</span><span class="o">)</span> <span class="c1">// Grouping by lagKey</span>
    <span class="o">.</span><span class="n">mapValues</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">tup</span> <span class="o">=&gt;</span> <span class="nc">Map</span><span class="o">(</span><span class="n">tup</span><span class="o">.</span><span class="n">_2</span> <span class="o">-&gt;</span> <span class="n">tup</span><span class="o">.</span><span class="n">_3</span><span class="o">)).</span><span class="n">flatten</span><span class="o">.</span><span class="n">toMap</span><span class="o">)</span>
  
  <span class="n">tmpMap</span><span class="k">:</span> <span class="kt">FinalModel</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<p>If a <code class="docutils literal notranslate"><span class="pre">lagKey</span></code> sequence only belongs to one of the models we are
comparing, the variation distance is maximal, i.e. 1. Otherwise, we
compute the total variation distance between the probabilities of
observing a sequence of <code class="docutils literal notranslate"><span class="pre">n</span></code> trends, following the sequence of trends
<code class="docutils literal notranslate"><span class="pre">lagKey</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">def</span> <span class="n">totalVarDist</span><span class="o">(</span><span class="n">m1</span><span class="k">:</span> <span class="kt">FinalModel</span><span class="o">,</span> <span class="n">m2</span><span class="k">:</span> <span class="kt">FinalModel</span><span class="o">)</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span><span class="p">,</span> <span class="kt">Double</span><span class="o">]</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">allKeys</span> <span class="o">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">toSet</span><span class="o">.</span><span class="n">union</span><span class="o">(</span><span class="n">m2</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">toSet</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">sharedKeys</span> <span class="o">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">toSet</span><span class="o">.</span><span class="n">intersect</span><span class="o">(</span><span class="n">m2</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">toSet</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">totalVarDists</span> <span class="o">=</span> <span class="n">allKeys</span><span class="o">.</span><span class="n">toSeq</span><span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="n">key</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">sharedKeys</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
      <span class="mf">1.0</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">val1</span> <span class="o">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="nc">Map</span><span class="o">())</span>
      <span class="k">val</span> <span class="n">val2</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="nc">Map</span><span class="o">())</span>
      <span class="k">val</span> <span class="n">allValKeys</span> <span class="o">=</span> <span class="n">val1</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">toSet</span><span class="o">.</span><span class="n">union</span><span class="o">(</span><span class="n">val2</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">toSet</span><span class="o">)</span>
      <span class="n">allValKeys</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">valKey</span> <span class="o">=&gt;</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">abs</span><span class="o">(</span><span class="n">val1</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="n">valKey</span><span class="o">,</span> <span class="mf">0.0</span><span class="o">)</span> <span class="o">-</span> <span class="n">val2</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="n">valKey</span><span class="o">,</span> <span class="mf">0.0</span><span class="o">))</span> <span class="o">).</span><span class="n">sum</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="n">allKeys</span><span class="o">.</span><span class="n">zip</span><span class="o">(</span><span class="n">totalVarDists</span><span class="o">).</span><span class="n">toMap</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>totalVarDist: (m1: FinalModel, m2: FinalModel)Map[Seq[Int],Double]
</pre></div>
</div>
</div>
</div>
<p>Computing the variation distance for all possible pairs of partially
trained models.</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">totalVariationDistances</span> <span class="o">=</span> <span class="n">partialModels</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">m1</span> <span class="o">=&gt;</span> <span class="n">partialModels</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">m2</span> <span class="o">=&gt;</span> <span class="n">totalVarDist</span><span class="o">(</span><span class="n">m1</span><span class="o">,</span><span class="n">m2</span><span class="o">)</span> <span class="o">)</span> <span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">def</span> <span class="n">aggToMatrix</span><span class="o">(</span><span class="n">totalVarDists</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Map</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span><span class="p">,</span><span class="kt">Double</span><span class="o">]]],</span> <span class="n">aggFunc</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="nc">Double</span><span class="o">)</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Double</span><span class="o">]]</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">totalVariationDistances</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">t</span> <span class="o">=&gt;</span> <span class="n">aggFunc</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">toSeq</span><span class="o">)))</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">printMatrix</span><span class="o">(</span><span class="n">mat</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Double</span><span class="o">]])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">mat</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">s</span> <span class="o">=&gt;</span> <span class="o">{</span> <span class="n">s</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">a</span> <span class="o">=&gt;</span> <span class="n">print</span><span class="o">(</span><span class="s">f&quot;</span><span class="si">$a</span><span class="s">%2.3f &quot;</span><span class="o">)</span> <span class="o">);</span> <span class="n">println</span><span class="o">()</span> <span class="o">}</span> <span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>aggToMatrix: (totalVarDists: Seq[Seq[Map[Seq[Int],Double]]], aggFunc: Seq[Double] =&gt; Double)Seq[Seq[Double]]
printMatrix: (mat: Seq[Seq[Double]])Unit
</pre></div>
</div>
</div>
</div>
<p>We compute three different metrics of the total variation distances.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">maxDists</span></code> is the <em>maximal</em> total variation distance over the
different <code class="docutils literal notranslate"><span class="pre">lagKey</span></code>s.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minDists</span></code> is the <em>minimal</em> total variation distance over the
different <code class="docutils literal notranslate"><span class="pre">lagKey</span></code>s.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">meanDists</span></code> is an estimate of the average total variation distance
over the different <code class="docutils literal notranslate"><span class="pre">lagKey</span></code>s.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="k">val</span> <span class="n">maxDists</span> <span class="o">=</span> <span class="n">aggToMatrix</span><span class="o">(</span><span class="n">totalVariationDistances</span><span class="o">,</span> <span class="n">s</span> <span class="o">=&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="o">)</span>
<span class="k">val</span> <span class="n">minDists</span> <span class="o">=</span> <span class="n">aggToMatrix</span><span class="o">(</span><span class="n">totalVariationDistances</span><span class="o">,</span> <span class="n">s</span> <span class="o">=&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">min</span><span class="o">)</span>
<span class="k">val</span> <span class="n">meanDists</span> <span class="o">=</span> <span class="n">aggToMatrix</span><span class="o">(</span><span class="n">totalVariationDistances</span><span class="o">,</span> <span class="n">s</span> <span class="o">=&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">sum</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">size</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>maxDists: Seq[Seq[Double]] = Vector(Vector(0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0), Vector(1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0), Vector(1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0), Vector(1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0), Vector(1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0), Vector(1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0), Vector(1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0), Vector(1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0), Vector(1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0), Vector(1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0))
minDists: Seq[Seq[Double]] = Vector(Vector(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.1111111111111111), Vector(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0), Vector(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0), Vector(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0), Vector(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0), Vector(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0), Vector(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0), Vector(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0), Vector(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0), Vector(0.1111111111111111, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0))
meanDists: Seq[Seq[Double]] = Vector(Vector(0.0, 0.8095238095238095, 0.9595959595959596, 0.9902676399026764, 0.9975932611311673, 0.9992509363295881, 0.999785112600997, 0.9999212988949179, 0.9999637818340489, 0.9999828303297199), Vector(0.8095238095238095, 0.0, 0.7878787878787878, 0.948905109489051, 0.9879412354592861, 0.9962818797931157, 0.9988235824354509, 0.9995277161089322, 0.9997797172802255, 0.9999006682605777), Vector(0.9595959595959596, 0.7878787878787878, 0.0, 0.7675182481751823, 0.9456465498353374, 0.9839165434703036, 0.9949339063117071, 0.9979342365055828, 0.9990263876562084, 0.9995453963182023), Vector(0.9902676399026764, 0.948905109489051, 0.7675182481751823, 0.0, 0.76569626045364, 0.9313390461281573, 0.9778513135067101, 0.9912980359273889, 0.9959873718299493, 0.998122961240012), Vector(0.9975932611311673, 0.9879412354592861, 0.9456465498353374, 0.76569626045364, 0.0, 0.709855350171288, 0.9069532060773262, 0.9635540738278638, 0.9834583301846547, 0.992240400344003), Vector(0.9992509363295881, 0.9962818797931157, 0.9839165434703036, 0.9313390461281573, 0.709855350171288, 0.0, 0.6846310864524279, 0.8780374739844375, 0.9450962905341598, 0.9743411917827652), Vector(0.999785112600997, 0.9988235824354509, 0.9949339063117071, 0.9778513135067101, 0.9069532060773262, 0.6846310864524279, 0.0, 0.6217124078957903, 0.8326340372200347, 0.9226862715145945), Vector(0.9999212988949179, 0.9995277161089322, 0.9979342365055828, 0.9912980359273889, 0.9635540738278638, 0.8780374739844375, 0.6217124078957903, 0.0, 0.5727678811689098, 0.8064805024139434), Vector(0.9999637818340489, 0.9997797172802255, 0.9990263876562084, 0.9959873718299493, 0.9834583301846547, 0.9450962905341598, 0.8326340372200347, 0.5727678811689098, 0.0, 0.5653398087664567), Vector(0.9999828303297199, 0.9999006682605777, 0.9995453963182023, 0.998122961240012, 0.992240400344003, 0.9743411917827652, 0.9226862715145945, 0.8064805024139434, 0.5653398087664567, 0.0))
</pre></div>
</div>
</div>
</div>
<p>Each model is a mapping <code class="docutils literal notranslate"><span class="pre">{key:</span> <span class="pre">{value:</span> <span class="pre">probability}}</span></code> where <code class="docutils literal notranslate"><span class="pre">key</span></code>
(<code class="docutils literal notranslate"><span class="pre">lagKey</span></code>) is a sequence of reversals and non-reversals of length <code class="docutils literal notranslate"><span class="pre">m</span></code>,
<code class="docutils literal notranslate"><span class="pre">value</span></code> is a sequence of trends of length <code class="docutils literal notranslate"><span class="pre">n</span></code> and <code class="docutils literal notranslate"><span class="pre">probability</span></code> is the
estimated probability that <code class="docutils literal notranslate"><span class="pre">value</span></code> is observed immediately following
<code class="docutils literal notranslate"><span class="pre">key</span></code>.</p>
<p>Hence, for any two models A and B, we can calculate the total variation
distance between the mappings <code class="docutils literal notranslate"><span class="pre">{value:</span> <span class="pre">probability}</span></code> for a given key in
the union of the keys for A and B. If a key is not present in one of the
models, the total variation distance is 1 for that key.</p>
<p>In the matrix below, the (i,j)-th position is the arithmetic mean of the
total variation distances for all keys in the union of the keysets. The
matrix is symmetric with the smallest model in the top row and leftmost
column and the largest model in the bottom row and rightmost column. All
diagonal elements are 0 since the total variation distance from one
model to itself is always 0.</p>
<p>If there are three models labeled M<em>1, M</em>2, M<em>3 and V</em>i_j is the
arithmetic mean described above, the matrix is</p>
<div class="math notranslate nohighlight">
\[  \begin{matrix} V_{1,1} &amp; V_{1,2} &amp; V_{1,3} \end{matrix} 
\]</div>
<div class="math notranslate nohighlight">
\[  \begin{matrix} V_{2,1} &amp; V_{2,2} &amp; V_{2,3} \end{matrix} 
\]</div>
<div class="math notranslate nohighlight">
\[  \begin{matrix} V_{3,1} &amp; V_{3,2} &amp; V_{3,3} \end{matrix} 
\]</div>
<p>As one can see, the models differ a lot from each other, suggesting that
the estimate can still be improved given more data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">scala</span>
<span class="n">printMatrix</span><span class="o">(</span><span class="n">meanDists</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.000 0.810 0.960 0.990 0.998 0.999 1.000 1.000 1.000 1.000 
0.810 0.000 0.788 0.949 0.988 0.996 0.999 1.000 1.000 1.000 
0.960 0.788 0.000 0.768 0.946 0.984 0.995 0.998 0.999 1.000 
0.990 0.949 0.768 0.000 0.766 0.931 0.978 0.991 0.996 0.998 
0.998 0.988 0.946 0.766 0.000 0.710 0.907 0.964 0.983 0.992 
0.999 0.996 0.984 0.931 0.710 0.000 0.685 0.878 0.945 0.974 
1.000 0.999 0.995 0.978 0.907 0.685 0.000 0.622 0.833 0.923 
1.000 1.000 0.998 0.991 0.964 0.878 0.622 0.000 0.573 0.806 
1.000 1.000 0.999 0.996 0.983 0.945 0.833 0.573 0.000 0.565 
1.000 1.000 1.000 0.998 0.992 0.974 0.923 0.806 0.565 0.000 
</pre></div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "scala212"
        },
        kernelOptions: {
            kernelName: "scala212",
            path: "./000_9-sds-3-x-trends"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'scala212'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="02_streamable_trend_calculus.html" title="previous page">Streaming Trend Calculus with Maximum Necessary Reversals</a>
    <a class='right-next' id="next-link" href="030_Spark_GDELT_project_001.html" title="next page">Plugging into GDELT Mass Media Streams</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By ScaDaMaLe Team<br/>
        
            &copy; Copyright 2020 Creative Commons Zero v1.0 Universal.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>